<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Firebase)</title>

  <style>
    :root{
      --bg:#0b1020;
      --text:#e8eeff;
      --muted:#a9b6e6;
      --line:rgba(255,255,255,.10);
      --friSat:rgba(255, 209, 102, .18);
      --accent:#7c5cff;
      --ok:#2fe7a4;
      --danger:#ff5c7a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Tahoma, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 0%, #1b2a6b 0%, transparent 55%),
        radial-gradient(900px 700px at 100% 30%, #4a1f6b 0%, transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1250px;margin:0 auto;padding:18px}

    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 16px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), #35c6ff);
      box-shadow:0 10px 30px rgba(124,92,255,.25);
    }
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      font-weight:800;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    button.primary{background:rgba(124,92,255,.25)}
    button.danger{background:rgba(255,92,122,.18)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);font-size:12px;color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.admin{background:var(--ok)}
    .dot.user{background:rgba(53,198,255,.7)}
    .dot.guest{background:rgba(255,255,255,.35)}
    .hint{
      font-size:12px;color:var(--muted);
      margin-top:10px;padding:10px 12px;border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;background:rgba(255,255,255,.04);
    }

    /* ===== Calendar ===== */
    .grid{margin-top:14px;display:grid;grid-template-columns:1fr;gap:14px}
    .weekCard{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:18px;
      overflow:hidden;
    }
    .weekHead{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:12px 14px;background:rgba(0,0,0,.18);border-bottom:1px solid var(--line);
    }
    .weekTitle{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .weekTitle strong{font-size:14px}
    .weekTitle span{font-size:12px;color:var(--muted)}
    .table{display:grid;grid-template-columns:repeat(7,1fr);border-top:1px solid var(--line)}
    .th,.td{padding:10px;border-left:1px solid var(--line);border-bottom:1px solid var(--line);min-height:98px;position:relative}
    .th{min-height:auto;font-weight:900;background:rgba(255,255,255,.04);text-align:center;padding:10px 6px}
    .th.friSat,.td.friSat{background:var(--friSat)}
    .th:last-child,.td:last-child{border-left:none}
    .gDate{font-size:12px;color:var(--muted)}
    .hDate{font-size:12px}
    .todayBadge{
      position:absolute;top:8px;left:8px;font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(47,231,164,.5);background:rgba(47,231,164,.12);color:var(--ok);font-weight:900;
    }
    .events{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .event{
      padding:6px 8px;border-radius:10px;font-size:12px;line-height:1.2;
      border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      display:flex;gap:8px;align-items:flex-start;justify-content:space-between;
    }
    .event .tag{width:10px;height:10px;border-radius:3px;flex:0 0 auto;background:var(--accent);margin-top:3px}
    .event .txt{flex:1 1 auto}
    .event .x{color:rgba(255,255,255,.7);cursor:pointer;font-weight:900;padding:0 6px;border-radius:8px;line-height:18px}
    .event .x:hover{background:rgba(255,255,255,.08)}
    .badgeScope{
      font-size:10px;padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      color:rgba(255,255,255,.9);background:rgba(0,0,0,.18);font-weight:900
    }

    /* ===== Modal ===== */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(1020px, 100%);
      max-height: calc(100vh - 24px);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(17,26,51,.98), rgba(15,23,48,.98));
      border-radius:18px;
      box-shadow:0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      position:sticky;top:0;z-index:3;
    }
    .modalHead strong{font-size:14px}
    .modalBody{
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:grid;
      gap:12px;
    }
    .modalFoot{
      padding:12px 14px;border-top:1px solid var(--line);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      position:sticky;bottom:0;z-index:3;
      background:rgba(15,23,48,.92);
      backdrop-filter: blur(10px);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea, select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .warn{border:1px solid rgba(255,92,122,.35);background:rgba(255,92,122,.10);padding:10px 12px;border-radius:14px}

    /* Tabs */
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;
    }
    .tabBtn{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);cursor:pointer;font-weight:900;color:var(--text);
    }
    .tabBtn.active{
      background:rgba(124,92,255,.28);
      border-color:rgba(124,92,255,.55);
    }
    .tabPane{display:none}
    .tabPane.active{display:block}

    .cardLite{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
    }

    /* Weeks table */
    .weeksWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .weeksToolbar{
      display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap;
      padding:10px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.16);
    }
    .weeksScroll{
      max-height: 55vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .weeksTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:900px;
    }
    .weeksTable th,.weeksTable td{
      border-bottom:1px solid var(--line);
      padding:10px;
      font-size:12px;
      vertical-align:middle;
      white-space:nowrap;
    }
    .weeksTable th{
      background:rgba(255,255,255,.04);
      color:var(--muted);
      text-align:right;
      font-weight:900;
      position:sticky;top:0;z-index:2;
    }
    /* âœ… Ensure controls work */
    .weeksScroll select,
    .weeksScroll input,
    .weeksScroll button{
      pointer-events:auto;
    }

    .miniBtn{padding:8px 10px;border-radius:10px;font-size:12px;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    @media (max-width: 860px){
      .row{grid-template-columns:1fr}
      .topbar{flex-direction:column;align-items:stretch}
      .actions{justify-content:space-between}
      .weeksTable{min-width:860px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h1>
          <div class="sub">Firebase + Firestore</div>
        </div>
      </div>

      <div class="actions">
        <span id="rolePill" class="pill"><span class="dot guest"></span><span>Ø²Ø§Ø¦Ø±</span></span>
        <button id="btnAuth" class="primary">Ø¯Ø®ÙˆÙ„</button>
        <button id="btnLogout" style="display:none;">Ø®Ø±ÙˆØ¬</button>
        <button id="btnAdminPanel" style="display:none;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button id="btnMyPanel" style="display:none;">Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø®Ø§Øµ</button>
      </div>
    </div>

    <div class="hint" id="compatHint">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù€ <b>Intl islamic-umalqura</b>.
    </div>

    <div class="grid" id="weeksGrid"></div>
  </div>

  <!-- Auth Modal -->
  <div class="modalBack" id="authBack">
    <div class="modal" style="width:min(560px, 100%);">
      <div class="modalHead">
        <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong>
        <button id="closeAuth">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modalBody">
        <div class="warn">
          <b>Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù‚ÙÙ‘Ù„.</b> Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙŠÙ†Ø´Ø¦Ù‡Ø§ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø·.
        </div>
        <div class="row">
          <div>
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="authEmail" type="email" placeholder="name@example.com" />
          </div>
          <div>
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button id="btnForgot" class="miniBtn">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
        <button id="btnSignin" class="primary">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modalBack" id="adminBack">
    <div class="modal">
      <div class="modalHead">
        <strong>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</strong>
        <button id="closeAdmin">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="modalBody">
        <div class="tabs">
          <button class="tabBtn active" data-tab="tabPublic">Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©</button>
          <button class="tabBtn" data-tab="tabWeeks">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</button>
        </div>

        <!-- Public -->
        <div id="tabPublic" class="tabPane active">
          <div class="cardLite">
            <div style="font-weight:900;margin-bottom:8px">Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¹Ø§Ù… (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹)</div>
            <div class="row">
              <div>
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø« (Ø¹Ø§Ù…)</label>
                <input id="pubDate" type="date" />
              </div>
              <div>
                <label>Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«</label>
                <input id="pubColor" type="color" value="#7c5cff" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø« (Ø¹Ø§Ù…)</label>
              <input id="pubTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" />
            </div>

            <div style="margin-top:10px">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <textarea id="pubNote" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea>
            </div>

            <div class="small" style="margin-top:10px">
              ğŸ’¡ Ø§Ø¶ØºØ· Ø²Ø± (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ù…) ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø­ÙØ¸.
            </div>
          </div>
        </div>

        <!-- Weeks -->
        <div id="tabWeeks" class="tabPane">
          <div class="cardLite">
            <div style="font-weight:900">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</div>
            <div class="small" style="margin-top:8px">
              - <b>startDateISO</b> ØªØ§Ø±ÙŠØ® <b>Ø§Ù„Ø£Ø­Ø¯</b> Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.<br>
              - <b>type</b>: week Ø£Ùˆ vac (Ø¥Ø¬Ø§Ø²Ø©).
            </div>
          </div>

          <div class="weeksWrap">
            <div class="weeksToolbar">
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnAddWeek" class="miniBtn">+ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹</button>
                <button id="btnAddVac" class="miniBtn">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø©</button>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnSaveWeeks" class="miniBtn primary">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</button>
              </div>
            </div>

            <div class="weeksScroll">
              <table class="weeksTable" id="weeksTable">
                <thead>
                  <tr>
                    <th>order</th>
                    <th>type</th>
                    <th>weekNumber</th>
                    <th>title</th>
                    <th>startDateISO (Ø£Ø­Ø¯)</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody id="weeksTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- âœ… Footer changes Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
      <div class="modalFoot" id="adminFoot">
        <div id="footPublic" style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="addPublicEvent" class="primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ù…</button>
        </div>

        <div id="footWeeks" style="display:none;gap:10px;flex-wrap:wrap">
          <button id="btnSaveWeeksFooter" class="primary">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- My Modal -->
  <div class="modalBack" id="myBack">
    <div class="modal" style="width:min(760px, 100%);">
      <div class="modalHead">
        <strong>Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø®Ø§Øµ (ÙŠØ¸Ù‡Ø± Ù„Ùƒ ÙÙ‚Ø·)</strong>
        <button id="closeMy">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø« (Ø®Ø§Øµ)</label>
            <input id="priDate" type="date" />
          </div>
          <div>
            <label>Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«</label>
            <input id="priColor" type="color" value="#35c6ff" />
          </div>
        </div>

        <div>
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø« (Ø®Ø§Øµ)</label>
          <input id="priTitle" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ØªØ§Ø¨Ø¹Ø© Ù…ØªØ¯Ø±Ø¨" />
        </div>

        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="priNote" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea>
        </div>

        <div class="small">ğŸ’¡ ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙŠÙˆÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„ÙØªØ­ Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø®Ø§Øµ Ø¨Ø³Ø±Ø¹Ø©.</div>
      </div>
      <div class="modalFoot">
        <button id="addPrivateEvent" class="primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø®Ø§Øµ</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, deleteDoc,
    onSnapshot, query, orderBy, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ========= Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§ ========= */
  const firebaseConfig = {
    apiKey: "PUT_HERE",
    authDomain: "PUT_HERE",
    projectId: "PUT_HERE",
    storageBucket: "PUT_HERE",
    messagingSenderId: "PUT_HERE",
    appId: "PUT_HERE"
  };

  /* ========= Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± ========= */
  const ADMIN_EMAILS = ["ensancom@gmail.com"];
  const ADMIN_EMAILS_NORM = ADMIN_EMAILS.map(e => (e||"").trim().toLowerCase());

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ========= Helpers ========= */
  const days = [
    {name:"Ø§Ù„Ø£Ø­Ø¯", off:false},
    {name:"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", off:false},
    {name:"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", off:false},
    {name:"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", off:false},
    {name:"Ø§Ù„Ø®Ù…ÙŠØ³", off:false},
    {name:"Ø§Ù„Ø¬Ù…Ø¹Ø©", off:true},
    {name:"Ø§Ù„Ø³Ø¨Øª", off:true},
  ];

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeekSunday(d){
    const x = new Date(d);
    const day = x.getDay();
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }
  function parseISOToDate(iso){ return new Date((iso||"").trim() + "T00:00:00"); }

  /* ========= Umm al-Qura ========= */
  const hasUmalqura = (() => {
    try{
      const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { day:"numeric" });
      return !!fmt.format(new Date());
    }catch(e){ return false; }
  })();
  const compatHint = document.getElementById("compatHint");
  compatHint.style.display = hasUmalqura ? "none" : "block";

  const fmtHijri = hasUmalqura
    ? new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { weekday:"long", year:"numeric", month:"long", day:"numeric" })
    : null;
  const fmtG = new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"2-digit", day:"2-digit" });

  /* ========= Default fallback weeks ========= */
  function buildDefaultWeekPlan(){
    const plan = [];
    for(let w=16; w<=19; w++) plan.push({ type:"week", weekNumber:w, title:`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}` });
    plan.push({ type:"vac", weekNumber:0, title:"Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)" });
    for(let w=1; w<=18; w++) plan.push({ type:"week", weekNumber:w, title:`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}` });
    return plan;
  }
  const basePlan = buildDefaultWeekPlan();

  function findGregorianForHijriFallback(){
    if(!hasUmalqura) return startOfWeekSunday(new Date());
    const targetY = 1447, targetDay = 23, monthName = "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©";
    const from = new Date("2025-06-01");
    const to = new Date("2026-06-30");
    const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric" });

    for(let t = new Date(from); t <= to; t = addDays(t, 1)){
      const s = fmt.format(t);
      const latin = s.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
      if(s.includes(monthName) && latin.includes(String(targetDay)) && latin.includes(String(targetY))){
        return startOfWeekSunday(t);
      }
    }
    return startOfWeekSunday(new Date());
  }
  const fallbackStartSunday = findGregorianForHijriFallback();

  function defaultWeeksFromFallback(){
    return basePlan.map((w, i)=>({
      id: null,
      order: i+1,
      type: w.type,
      weekNumber: w.weekNumber,
      title: w.title,
      startDateISO: toISODate(addDays(fallbackStartSunday, i*7))
    }));
  }

  /* ========= State ========= */
  const state = {
    user: null,
    isAdmin: false,
    publicEvents: [],
    privateEvents: [],
    weeks: []
  };

  /* ========= Elements ========= */
  const weeksGrid = document.getElementById("weeksGrid");
  const rolePill = document.getElementById("rolePill");
  const btnAuth = document.getElementById("btnAuth");
  const btnLogout = document.getElementById("btnLogout");
  const btnAdminPanel = document.getElementById("btnAdminPanel");
  const btnMyPanel = document.getElementById("btnMyPanel");

  // Auth modal
  const authBack = document.getElementById("authBack");
  const closeAuth = document.getElementById("closeAuth");
  const authEmail = document.getElementById("authEmail");
  const authPass = document.getElementById("authPass");
  const btnSignin = document.getElementById("btnSignin");
  const btnForgot = document.getElementById("btnForgot");

  // Admin modal
  const adminBack = document.getElementById("adminBack");
  const closeAdmin = document.getElementById("closeAdmin");

  const pubDate = document.getElementById("pubDate");
  const pubColor = document.getElementById("pubColor");
  const pubTitle = document.getElementById("pubTitle");
  const pubNote = document.getElementById("pubNote");
  const addPublicEventBtn = document.getElementById("addPublicEvent");

  const weeksTbody = document.getElementById("weeksTbody");
  const btnAddWeek = document.getElementById("btnAddWeek");
  const btnAddVac = document.getElementById("btnAddVac");
  const btnSaveWeeks = document.getElementById("btnSaveWeeks");

  // Footer switch
  const footPublic = document.getElementById("footPublic");
  const footWeeks  = document.getElementById("footWeeks");
  const btnSaveWeeksFooter = document.getElementById("btnSaveWeeksFooter");

  // My modal
  const myBack = document.getElementById("myBack");
  const closeMy = document.getElementById("closeMy");
  const priDate = document.getElementById("priDate");
  const priColor = document.getElementById("priColor");
  const priTitle = document.getElementById("priTitle");
  const priNote = document.getElementById("priNote");
  const addPrivateEventBtn = document.getElementById("addPrivateEvent");

  function openModal(el){ el.style.display = "flex"; }
  function closeModal(el){ el.style.display = "none"; }

  [authBack, adminBack, myBack].forEach(back => {
    back.addEventListener("click", (e)=>{ if(e.target === back) closeModal(back); });
  });

  closeAuth.onclick = ()=>closeModal(authBack);
  closeAdmin.onclick = ()=>closeModal(adminBack);
  closeMy.onclick = ()=>closeModal(myBack);

  btnAuth.onclick = ()=>openModal(authBack);
  btnLogout.onclick = async ()=>{ await signOut(auth); };

  btnMyPanel.onclick = ()=>{ if(state.user) openModal(myBack); };

  btnSignin.onclick = async ()=>{
    const email = authEmail.value.trim();
    const pass = authPass.value;
    if(!email || !pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      closeModal(authBack);
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    }
  };

  btnForgot.onclick = async ()=>{
    const email = authEmail.value.trim();
    if(!email) return alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹.");
    try{
      await sendPasswordResetEmail(auth, email);
      alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ. (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ§Ø±Ø¯/Ø§Ù„Ø³Ø¨Ø§Ù…)");
    }catch(err){
      alert(err?.message || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.");
    }
  };

  function setRolePill(){
    if(state.isAdmin){
      rolePill.innerHTML = `<span class="dot admin"></span><span>Ù…Ø¯ÙŠØ±: ${escapeHtml(state.user.email)}</span>`;
    } else if(state.user){
      rolePill.innerHTML = `<span class="dot user"></span><span>Ù…Ø³ØªØ®Ø¯Ù…: ${escapeHtml(state.user.email)}</span>`;
    } else {
      rolePill.innerHTML = `<span class="dot guest"></span><span>Ø²Ø§Ø¦Ø±</span>`;
    }
    btnLogout.style.display = state.user ? "inline-block" : "none";
    btnAdminPanel.style.display = state.isAdmin ? "inline-block" : "none";
    btnMyPanel.style.display = state.user ? "inline-block" : "none";
  }

  /* ========= Tabs logic (FIXED) ========= */
  const tabButtons = Array.from(document.querySelectorAll(".tabBtn"));
  const tabPanes = Array.from(document.querySelectorAll(".tabPane"));

  function setActiveTab(tabId){
    tabButtons.forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
    tabPanes.forEach(p => p.classList.toggle("active", p.id === tabId));

    const isWeeks = (tabId === "tabWeeks");
    footPublic.style.display = isWeeks ? "none" : "flex";
    footWeeks.style.display  = isWeeks ? "flex" : "none";

    if(isWeeks) renderWeeksEditor();
  }

  tabButtons.forEach(btn=>{
    btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
  });

  btnSaveWeeksFooter.onclick = () => btnSaveWeeks.click();

  btnAdminPanel.onclick = ()=>{
    if(!state.isAdmin) return;
    openModal(adminBack);
    setActiveTab("tabPublic");
  };

  /* ========= Firestore listeners ========= */
  let unsubPublic = null;
  let unsubPrivate = null;
  let unsubWeeksPlan = null;

  function listenPublicEvents(){
    const qy = query(collection(db, "publicEvents"), orderBy("dateISO", "asc"));
    return onSnapshot(qy, (snap)=>{
      state.publicEvents = snap.docs.map(d => ({ id:d.id, scope:"public", ...d.data() }));
      render();
    });
  }

  function listenPrivateEvents(uid){
    const qy = query(collection(db, `users/${uid}/privateEvents`), orderBy("dateISO", "asc"));
    return onSnapshot(qy, (snap)=>{
      state.privateEvents = snap.docs.map(d => ({ id:d.id, scope:"private", ...d.data() }));
      render();
    });
  }

  function listenWeeksPlan(){
    const qy = query(collection(db, "publicWeeks"), orderBy("order", "asc"));
    return onSnapshot(qy, (snap)=>{
      state.weeks = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      render();
      if(adminBack.style.display === "flex") renderWeeksEditor();
    });
  }

  async function deleteEvent(ev){
    try{
      if(ev.scope === "public"){
        if(!state.isAdmin) return;
        await deleteDoc(doc(db, "publicEvents", ev.id));
      } else {
        if(!state.user) return;
        await deleteDoc(doc(db, `users/${state.user.uid}/privateEvents`, ev.id));
      }
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
    }
  }

  /* ========= Add Events ========= */
  addPublicEventBtn.onclick = async ()=>{
    if(!state.isAdmin) return;

    const dateISO = pubDate.value;
    const title = pubTitle.value.trim();
    const note = pubNote.value.trim();
    const color = pubColor.value || "#7c5cff";
    if(!dateISO) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø«.");
    if(!title) return alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«.");

    try{
      await addDoc(collection(db, "publicEvents"), { dateISO, title, note, color, createdAt: Date.now() });
      pubTitle.value = ""; pubNote.value = "";
      alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ù….");
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ù….");
    }
  };

  addPrivateEventBtn.onclick = async ()=>{
    if(!state.user) return;

    const dateISO = priDate.value;
    const title = priTitle.value.trim();
    const note = priNote.value.trim();
    const color = priColor.value || "#35c6ff";
    if(!dateISO) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¯Ø«.");
    if(!title) return alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«.");

    try{
      await addDoc(collection(db, `users/${state.user.uid}/privateEvents`), { dateISO, title, note, color, createdAt: Date.now() });
      priTitle.value = ""; priNote.value = "";
      alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø®Ø§Øµ.");
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø®Ø§Øµ.");
    }
  };

  /* ========= Weeks Editor ========= */
  let weeksDraft = [];

  function normalizeWeeksDraft(){
    weeksDraft = weeksDraft
      .map(w => ({
        ...w,
        order: Number(w.order || 0),
        weekNumber: Number(w.weekNumber || 0),
        title: (w.title || "").trim(),
        type: (w.type === "vac" ? "vac" : "week"),
        startDateISO: (w.startDateISO || "").trim()
      }))
      .sort((a,b)=>a.order-b.order);

    weeksDraft.forEach((w, i)=>{
      if(!w.order || w.order < 1) w.order = i+1;
    });
    weeksDraft.sort((a,b)=>a.order-b.order);
  }

  function renderWeeksEditor(){
    const src = (state.weeks && state.weeks.length) ? state.weeks : defaultWeeksFromFallback();
    weeksDraft = src.map(w => ({
      id: w.id || null,
      order: w.order,
      type: w.type || "week",
      weekNumber: Number(w.weekNumber || 0),
      title: w.title || "",
      startDateISO: w.startDateISO || ""
    }));
    normalizeWeeksDraft();

    weeksTbody.innerHTML = "";
    weeksDraft.forEach((w, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="mono" data-k="order" data-i="${idx}" type="number" min="1" value="${escapeHtml(w.order)}"></td>
        <td>
          <select data-k="type" data-i="${idx}">
            <option value="week" ${w.type==="week"?"selected":""}>week</option>
            <option value="vac" ${w.type==="vac"?"selected":""}>vac</option>
          </select>
        </td>
        <td><input class="mono" data-k="weekNumber" data-i="${idx}" type="number" min="0" value="${escapeHtml(w.weekNumber)}"></td>
        <td><input data-k="title" data-i="${idx}" type="text" value="${escapeHtml(w.title)}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹"></td>
        <td><input class="mono" data-k="startDateISO" data-i="${idx}" type="date" value="${escapeHtml(w.startDateISO)}"></td>
        <td><button class="miniBtn danger" data-act="del" data-i="${idx}">Ø­Ø°Ù</button></td>
      `;
      weeksTbody.appendChild(tr);
    });

    // inputs & selects
    weeksTbody.querySelectorAll("input,select").forEach(el=>{
      const apply = ()=>{
        const i = Number(el.getAttribute("data-i"));
        const k = el.getAttribute("data-k");
        if(Number.isNaN(i) || !k) return;

        let v = el.value;
        if(k === "order" || k === "weekNumber") v = Number(v || 0);
        weeksDraft[i][k] = v;

        if(k === "type" && v === "vac"){
          weeksDraft[i].weekNumber = 0;
        }
      };
      el.addEventListener("input", apply);
      el.addEventListener("change", ()=>{
        apply();
        if(el.getAttribute("data-k")==="type") renderWeeksEditor();
      });
    });

    // delete
    weeksTbody.querySelectorAll('button[data-act="del"]').forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const i = Number(btn.getAttribute("data-i"));
        if(Number.isNaN(i)) return;
        const item = weeksDraft[i];
        if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ")) return;
        try{
          if(item.id){
            await deleteDoc(doc(db, "publicWeeks", item.id));
          } else {
            weeksDraft.splice(i, 1);
            renderWeeksEditor();
          }
        }catch(err){
          alert(err?.message || "ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.");
        }
      });
    });
  }

  btnAddWeek.onclick = ()=>{
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)), 0);
    weeksDraft.push({ id:null, order:maxOrder+1, type:"week", weekNumber:0, title:"Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯", startDateISO:"" });
    renderWeeksEditor();
  };

  btnAddVac.onclick = ()=>{
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)), 0);
    weeksDraft.push({ id:null, order:maxOrder+1, type:"vac", weekNumber:0, title:"Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)", startDateISO:"" });
    renderWeeksEditor();
  };

  btnSaveWeeks.onclick = async ()=>{
    if(!state.isAdmin) return;

    normalizeWeeksDraft();
    for(const w of weeksDraft){
      if(!w.startDateISO) return alert("ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© (startDateISO).");
      if(w.type !== "vac" && (!w.title || w.title.trim()==="")) return alert("ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†.");
    }

    try{
      const snap = await getDocs(collection(db, "publicWeeks"));
      const batch = writeBatch(db);
      snap.docs.forEach(d => batch.delete(d.ref));

      weeksDraft.sort((a,b)=>a.order-b.order).forEach(w=>{
        const ref = doc(collection(db, "publicWeeks"));
        batch.set(ref, {
          order: Number(w.order),
          type: w.type === "vac" ? "vac" : "week",
          weekNumber: Number(w.weekNumber || 0),
          title: (w.title || "").trim(),
          startDateISO: (w.startDateISO || "").trim()
        });
      });

      await batch.commit();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­.");
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹.");
    }
  };

  /* ========= Auth state ========= */
  onAuthStateChanged(auth, (user)=>{
    state.user = user;
    const email = (user?.email || "").trim().toLowerCase();
    state.isAdmin = !!user && ADMIN_EMAILS_NORM.includes(email);

    if(unsubPublic) unsubPublic();
    if(unsubPrivate) unsubPrivate();
    if(unsubWeeksPlan) unsubWeeksPlan();

    unsubWeeksPlan = listenWeeksPlan();
    unsubPublic = listenPublicEvents();
    unsubPrivate = user ? listenPrivateEvents(user.uid) : null;

    setRolePill();
    render();
  });

  /* ========= Render calendar ========= */
  function render(){
    setRolePill();

    const events = [...state.publicEvents, ...(state.user ? state.privateEvents : [])];
    const todayISO = toISODate(new Date());

    const plan = (state.weeks && state.weeks.length)
      ? state.weeks.slice().sort((a,b)=>Number(a.order)-Number(b.order))
      : defaultWeeksFromFallback();

    weeksGrid.innerHTML = "";

    plan.forEach((w)=>{
      const weekStart = parseISOToDate(w.startDateISO);
      const weekEnd = addDays(weekStart, 6);

      const card = document.createElement("div");
      card.className = "weekCard";

      const head = document.createElement("div");
      head.className = "weekHead";

      const titleDiv = document.createElement("div");
      titleDiv.className = "weekTitle";

      const baseTitle =
        (w.title && String(w.title).trim()) ? w.title :
        (w.type === "vac" ? "Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)" : `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${Number(w.weekNumber||0)}`);

      const rangeG = `${fmtG.format(weekStart)} â€” ${fmtG.format(weekEnd)}`;
      const rangeH = hasUmalqura ? `${fmtHijri.format(weekStart)} â€” ${fmtHijri.format(weekEnd)}` : "";
      const labelWeek = (w.type === "week" && Number(w.weekNumber||0) > 0)
        ? `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${Number(w.weekNumber)}`
        : (w.type==="vac"?"Ø¥Ø¬Ø§Ø²Ø©":"");

      titleDiv.innerHTML = `
        <strong>${escapeHtml(baseTitle)}</strong>
        <span>(${escapeHtml(rangeG)}${hasUmalqura ? " | " + escapeHtml(rangeH) : ""}${labelWeek ? " â€” " + escapeHtml(labelWeek) : ""})</span>
      `;

      head.appendChild(titleDiv);
      card.appendChild(head);

      const table = document.createElement("div");
      table.className = "table";

      days.forEach(d=>{
        const th = document.createElement("div");
        th.className = "th" + (d.off ? " friSat" : "");
        th.textContent = d.name;
        table.appendChild(th);
      });

      days.forEach((d, di)=>{
        const date = addDays(weekStart, di);
        const iso = toISODate(date);

        const td = document.createElement("div");
        td.className = "td" + (d.off ? " friSat" : "");

        const hTxt = hasUmalqura ? fmtHijri.format(date) : "â€”";
        td.innerHTML = `<div class="gDate">${escapeHtml(fmtG.format(date))}</div><div class="hDate">${escapeHtml(hTxt)}</div>`;

        if(iso === todayISO){
          const b = document.createElement("div");
          b.className = "todayBadge";
          b.textContent = "Ø§Ù„ÙŠÙˆÙ…";
          td.appendChild(b);
        }

        const evWrap = document.createElement("div");
        evWrap.className = "events";

        events.filter(e => e.dateISO === iso).forEach(ev=>{
          const item = document.createElement("div");
          item.className = "event";
          item.innerHTML = `
            <span class="tag" style="background:${ev.color || "#7c5cff"}"></span>
            <div class="txt">
              <div style="font-weight:900">${escapeHtml(ev.title)}</div>
              ${ev.note ? `<div class="small">${escapeHtml(ev.note)}</div>` : ""}
              <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
                <span class="badgeScope">${ev.scope === "public" ? "Ø¹Ø§Ù…" : "Ø®Ø§Øµ"}</span>
              </div>
            </div>
            ${(ev.scope==="private" && state.user) || (ev.scope==="public" && state.isAdmin) ? `<div class="x" title="Ø­Ø°Ù">Ã—</div>` : ""}
          `;
          const x = item.querySelector(".x");
          if(x){
            x.onclick = ()=>{
              if(confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«ØŸ")) deleteEvent(ev);
            };
          }
          evWrap.appendChild(item);
        });

        td.appendChild(evWrap);

        td.style.cursor = state.user ? "pointer" : "default";
        td.onclick = ()=>{
          if(!state.user) return;
          priDate.value = iso;
          priTitle.value = "";
          priNote.value = "";
          openModal(myBack);
          priTitle.focus();
        };

        table.appendChild(td);
      });

      card.appendChild(table);
      weeksGrid.appendChild(card);
    });
  }

  setRolePill();
  render();
</script>
</body>
</html>

