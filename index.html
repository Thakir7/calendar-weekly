<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Pro v3)</title>

  <style>
    :root{
      --bg:#0f172a; --line:rgba(255,255,255,.10); --text:#e6eeff; --muted:#a7b4e6;
      --accent:#7c5cff; --ok:#2fe7a4; --warn:#ffd166; --danger:#ff5c7a;
      --friSat: rgba(255, 209, 102, .16);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Tahoma, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(124,92,255,.28), transparent 55%),
        radial-gradient(1000px 700px at 90% 25%, rgba(47,231,164,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:16px; padding:12px 14px; backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), #35c6ff);
      box-shadow:0 10px 30px rgba(124,92,255,.25);
    }
    h1{margin:0;font-size:16px}
    .sub{margin-top:2px;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-size:12px;color:var(--muted);
      max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.guest{background:rgba(255,255,255,.35)}
    .dot.user{background:rgba(53,198,255,.8)}
    .dot.admin{background:var(--ok)}
    button{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px;border-radius:12px; cursor:pointer;
      font-weight:900; transition:.12s transform,.12s background;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    button.primary{background:rgba(124,92,255,.25);border-color:rgba(124,92,255,.45)}
    button.danger{background:rgba(255,92,122,.16);border-color:rgba(255,92,122,.35)}
    button.soft{background:rgba(47,231,164,.10);border-color:rgba(47,231,164,.25)}
    button.ghost{background:transparent;border-color:rgba(255,255,255,.14)}

    .note{
      margin-top:12px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04); border-radius:14px;
      padding:10px 12px; color:var(--muted); font-size:12px;
    }

    .panels{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}
    .panel{border:1px solid var(--line);border-radius:16px;overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    .panelHead{
      padding:12px 14px; display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      background:rgba(0,0,0,.18); border-bottom:1px solid var(--line); user-select:none;
    }
    .panelHead strong{font-size:13px}
    .panelBody{padding:12px 14px}
    .accordionHead{cursor:pointer}
    .accordionHead:hover{background:rgba(255,255,255,.06)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:860px){ .grid2{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .weeks{margin-top:14px;display:grid;gap:12px}
    .week{border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:16px; overflow:hidden;
    }
    .weekHead{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.18);
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .weekHead .title{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .weekHead .title strong{font-size:13px}
    .weekHead .title span{font-size:12px;color:var(--muted)}
    .table{display:grid; grid-template-columns: repeat(7, 1fr); border-top:1px solid var(--line)}
    .th,.td{padding:10px;border-left:1px solid var(--line);border-bottom:1px solid var(--line);min-height:96px;position:relative}
    .th{min-height:auto;background:rgba(255,255,255,.04);text-align:center;font-weight:900;padding:10px 6px}
    .th:last-child,.td:last-child{border-left:none}
    .friSat{background:var(--friSat)}
    .gDate{font-size:12px;color:var(--muted)}
    .hDate{font-size:12px}
    .today{
      position:absolute;top:8px;left:8px;font-size:11px;font-weight:900;color:var(--ok);
      padding:4px 8px;border-radius:999px;border:1px solid rgba(47,231,164,.45);background:rgba(47,231,164,.12);
    }
    .events{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .ev{
      display:flex;gap:8px;align-items:flex-start;justify-content:space-between;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      border-radius:12px; padding:6px 8px; font-size:12px;
    }
    .ev .tag{width:10px;height:10px;border-radius:3px;margin-top:3px;flex:0 0 auto}
    .ev .txt{flex:1}
    .ev .x{cursor:pointer;font-weight:900;color:rgba(255,255,255,.75);padding:0 6px;border-radius:8px;line-height:18px}
    .ev .x:hover{background:rgba(255,255,255,.08)}
    .badge{
      display:inline-flex;font-size:10px;font-weight:900;
      padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18); margin-top:6px;color:rgba(255,255,255,.9);
    }

    .scroll{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
    th,td{border-bottom:1px solid var(--line);padding:10px;font-size:12px;white-space:nowrap}
    th{position:sticky;top:0;background:rgba(255,255,255,.04);color:var(--muted);text-align:right;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}

    .warnBox{
      border:1px solid rgba(255,209,102,.35);
      background:rgba(255,209,102,.10);
      border-radius:14px; padding:10px 12px; font-size:12px; color:rgba(255,255,255,.92);
    }
    .chev{opacity:.9;font-weight:900}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:720px;
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      backdrop-filter: blur(12px);
      overflow:hidden;
      box-shadow:0 30px 90px rgba(0,0,0,.45);
    }
    .modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.20);
    }
    .modalHead strong{font-size:13px}
    .modalBody{padding:12px 14px}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Pro v3)</h1>
        <div class="sub">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±: Ø£Ø³Ø§Ø¨ÙŠØ¹/Ø¥Ø¬Ø§Ø²Ø§Øª + Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù + CSV) â€” Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
    </div>

    <div class="actions">
      <span id="rolePill" class="pill"><span class="dot guest"></span><span>Ø²Ø§Ø¦Ø±</span></span>
      <button id="btnShowLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
      <button id="btnLogout" style="display:none;">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="demoNote" class="note" style="display:none;"></div>

  <!-- Login -->
  <div class="panels" id="loginPanel" style="display:none;">
    <div class="panel">
      <div class="panelHead">
        <strong>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong>
        <span class="sub">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ØºÙ„Ù‚ â€” Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ†Ø´Ø¦ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Firebase</span>
      </div>
      <div class="panelBody">
        <div class="grid2">
          <div>
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="loginEmail" type="email" placeholder="name@example.com">
          </div>
          <div>
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
        </div>
        <div style="margin-top:10px" class="rowBtns">
          <button id="btnForgot" class="soft">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
          <button id="btnLogin" class="primary">Ø¯Ø®ÙˆÙ„</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="panels" id="adminPanel" style="display:none;">
    <div class="panel">
      <div class="panelHead">
        <strong>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</strong>
        <span class="sub">Admins: admins/{uid}</span>
      </div>
      <div class="panelBody">
        <div class="warnBox" style="margin-bottom:10px">
          âœ… Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†: Ø£Ù†Ø´Ø¦ ÙˆØ«ÙŠÙ‚Ø© ÙÙŠ Firestore Ø¯Ø§Ø®Ù„ <b>admins</b> Ùˆ Document ID = <b>UID</b> Ù„Ù„Ù…Ø¯ÙŠØ±.
        </div>

        <div class="grid2">

          <!-- Public Events Manage -->
          <div class="panel" style="border-radius:14px">
            <div id="publicHead" class="panelHead accordionHead">
              <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø©</strong>
              <span class="sub">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù + CSV</span>
              <span class="chev" id="publicChev">â–¾</span>
            </div>
            <div id="publicBox" class="panelBody" style="display:none;">

              <div class="note">
                ğŸ’¡ Ø£Ø³Ø±Ø¹ Ø·Ø±ÙŠÙ‚Ø©: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø«Ù… Ø§Ø®ØªØ± "Ø¹Ø§Ù…" Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©.
              </div>

              <div class="rowBtns" style="justify-content:flex-start;margin-top:10px">
                <button id="btnAdminAddPublicFromPanel" class="soft">+ Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¹Ø§Ù…</button>
                <button id="btnRefreshPublicList" class="ghost">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
              </div>

              <div class="scroll" style="margin-top:10px">
                <table>
                  <thead>
                    <tr>
                      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                      <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                      <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                      <th>Ù„ÙˆÙ†</th>
                      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody id="publicEventsTbody"></tbody>
                </table>
              </div>

              <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

              <strong style="font-size:13px">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV (Ø¹Ø§Ù…Ø©)</strong>
              <div class="note" style="margin-top:8px">
                Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: <span class="mono">dateISO,title,note,color</span>
              </div>
              <div class="grid2" style="margin-top:10px">
                <div>
                  <label>Ù…Ù„Ù CSV</label>
                  <input id="csvFile" type="file" accept=".csv,text/csv">
                </div>
                <div>
                  <label>Ø§Ù„Ø³Ù„ÙˆÙƒ</label>
                  <select id="csvMode">
                    <option value="append">Ø¥Ø¶Ø§ÙØ© (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…)</option>
                    <option value="replace_public">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (ÙŠØ­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ø© Ø«Ù… ÙŠØ¶ÙŠÙ)</option>
                  </select>
                </div>
              </div>
              <div class="rowBtns" style="margin-top:10px;justify-content:flex-start">
                <button id="btnCsvPreview" class="soft">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                <button id="btnCsvImport" class="primary">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
              </div>
              <div id="csvResult" class="note" style="display:none;"></div>
            </div>
          </div>

          <!-- Weeks -->
          <div class="panel" style="border-radius:14px">
            <div id="weeksHead" class="panelHead accordionHead">
              <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</strong>
              <span class="sub">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­ÙØ¸</span>
              <span class="chev" id="weeksChev">â–¾</span>
            </div>
            <div id="weeksBox" class="panelBody" style="display:none;">
              <div class="rowBtns" style="justify-content:flex-start">
                <button id="btnAddWeek" class="soft">+ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹</button>
                <button id="btnAddVac" class="soft">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø©</button>
                <button id="btnSaveWeeks" class="primary">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</button>
              </div>

              <div style="margin-top:10px" class="scroll">
                <table>
                  <thead>
                    <tr>
                      <th>order</th>
                      <th>type</th>
                      <th>weekNumber</th>
                      <th>title</th>
                      <th>startDateISO (Ø£Ø­Ø¯)</th>
                      <th>Ø­Ø°Ù</th>
                    </tr>
                  </thead>
                  <tbody id="weeksTbody"></tbody>
                </table>
              </div>

              <div class="note" style="margin-top:10px">
                Ù…Ù„Ø§Ø­Ø¸Ø©: <b>startDateISO</b> Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ØªØ§Ø±ÙŠØ® <b>Ø§Ù„Ø£Ø­Ø¯</b> Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.
              </div>
            </div>
          </div>

        </div><!-- grid2 -->
      </div>
    </div>
  </div>

  <!-- Calendar -->
  <div class="weeks" id="weeksGrid"></div>
</div>

<!-- Modal: Add/Edit Event (click day) -->
<div id="modalBack" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <strong id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="modalHint" class="hint"></span>
        <button id="btnCloseModal" class="danger" style="padding:8px 10px">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="mDate" type="date">
        </div>
        <div>
          <label>Ø§Ù„Ù„ÙˆÙ†</label>
          <input id="mColor" type="color" value="#35c6ff">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="mTitle" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«">
      </div>

      <div style="margin-top:10px">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="mNote" placeholder="ØªÙØ§ØµÙŠÙ„..."></textarea>
      </div>

      <div id="scopeWrap" style="margin-top:10px;display:none">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)</label>
        <select id="mScope">
          <option value="private">Ø®Ø§Øµ (Ù„ÙŠ ÙÙ‚Ø·)</option>
          <option value="public">Ø¹Ø§Ù… (Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
        </select>
      </div>

      <div class="rowBtns" style="margin-top:12px">
        <button id="btnSaveModal" class="primary">Ø­ÙØ¸</button>
      </div>

      <div class="note" style="margin-top:10px">
        ğŸ’¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ÙŠÙ Ø®Ø§Øµ ÙÙ‚Ø·. Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø¹Ø§Ù…/Ø®Ø§Øµ.
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, addDoc, deleteDoc, updateDoc,
    onSnapshot, query, orderBy, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ===== Firebase Config ===== */
  const firebaseConfig = {
  apiKey: "AIzaSyAulObTByvUjUgz_8QD3el0DRKacmbdH9Y",
  authDomain: "calendar-w-2fcbe.firebaseapp.com",
  projectId: "calendar-w-2fcbe",
  storageBucket: "calendar-w-2fcbe.firebasestorage.app",
  messagingSenderId: "544490738732",
  appId: "1:544490738732:web:f1008e65eaa0c83b23ed89",
  measurementId: "G-MSBWPX2C75"
  };

  const days = [
    {name:"Ø§Ù„Ø£Ø­Ø¯", off:false},{name:"Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", off:false},{name:"Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", off:false},
    {name:"Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", off:false},{name:"Ø§Ù„Ø®Ù…ÙŠØ³", off:false},{name:"Ø§Ù„Ø¬Ù…Ø¹Ø©", off:true},{name:"Ø§Ù„Ø³Ø¨Øª", off:true},
  ];

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toISODate(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeekSunday(d){
    const x=new Date(d); const day=x.getDay();
    x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;
  }
  function parseISOToDate(iso){ return new Date((iso||"").trim()+"T00:00:00"); }
  function isValidISODate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||"").trim()); }
  function normColor(c){
    const x=String(c||"").trim();
    if(/^#[0-9a-fA-F]{6}$/.test(x)) return x;
    return "#7c5cff";
  }

  /* ===== Umm al-Qura ===== */
  const hasUmalqura = (() => {
    try{
      const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { day:"numeric" });
      return !!fmt.format(new Date());
    }catch(e){ return false; }
  })();
  const fmtHijri = hasUmalqura
    ? new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric" })
    : null;
  const fmtG = new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"2-digit", day:"2-digit" });

  /* ===== Default weeks plan ===== */
  function buildDefaultWeekPlan(){
    const plan=[];
    for(let w=16; w<=19; w++) plan.push({ type:"week", weekNumber:w, title:`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}` });
    plan.push({ type:"vac", weekNumber:0, title:"Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)" });
    for(let w=1; w<=18; w++) plan.push({ type:"week", weekNumber:w, title:`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${w}` });
    return plan;
  }
  const basePlan = buildDefaultWeekPlan();
  const fallbackStartSunday = startOfWeekSunday(new Date());
  function defaultWeeksFromFallback(){
    return basePlan.map((w,i)=>({
      id:null, order:i+1, type:w.type, weekNumber:w.weekNumber, title:w.title,
      startDateISO: toISODate(addDays(fallbackStartSunday, i*7))
    }));
  }

  /* ===== UI ===== */
  const rolePill = document.getElementById("rolePill");
  const demoNote = document.getElementById("demoNote");
  const weeksGrid = document.getElementById("weeksGrid");

  const loginPanel = document.getElementById("loginPanel");
  const adminPanel = document.getElementById("adminPanel");

  const btnShowLogin = document.getElementById("btnShowLogin");
  const btnLogout    = document.getElementById("btnLogout");

  const loginEmail = document.getElementById("loginEmail");
  const loginPass  = document.getElementById("loginPass");
  const btnLogin   = document.getElementById("btnLogin");
  const btnForgot  = document.getElementById("btnForgot");

  const publicHead = document.getElementById("publicHead");
  const publicBox  = document.getElementById("publicBox");
  const publicChev = document.getElementById("publicChev");

  const publicEventsTbody = document.getElementById("publicEventsTbody");
  const btnAdminAddPublicFromPanel = document.getElementById("btnAdminAddPublicFromPanel");
  const btnRefreshPublicList = document.getElementById("btnRefreshPublicList");

  const weeksHead = document.getElementById("weeksHead");
  const weeksBox  = document.getElementById("weeksBox");
  const weeksChev = document.getElementById("weeksChev");

  const btnAddWeek = document.getElementById("btnAddWeek");
  const btnAddVac  = document.getElementById("btnAddVac");
  const btnSaveWeeks = document.getElementById("btnSaveWeeks");
  const weeksTbody = document.getElementById("weeksTbody");

  // CSV
  const csvFile = document.getElementById("csvFile");
  const csvMode = document.getElementById("csvMode");
  const btnCsvPreview = document.getElementById("btnCsvPreview");
  const btnCsvImport  = document.getElementById("btnCsvImport");
  const csvResult = document.getElementById("csvResult");

  // Modal
  const modalBack = document.getElementById("modalBack");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnSaveModal  = document.getElementById("btnSaveModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalHint  = document.getElementById("modalHint");

  const mDate  = document.getElementById("mDate");
  const mColor = document.getElementById("mColor");
  const mTitle = document.getElementById("mTitle");
  const mNote  = document.getElementById("mNote");
  const scopeWrap = document.getElementById("scopeWrap");
  const mScope = document.getElementById("mScope");

  const state = {
    user:null,
    isAdmin:false,
    firebaseReady:false,
    publicEvents:[],
    privateEvents:[],
    weeks:[]
  };

  function setRolePill(){
    if(state.isAdmin){
      rolePill.innerHTML = `<span class="dot admin"></span><span>Ù…Ø¯ÙŠØ±: ${escapeHtml(state.user?.email||"")}</span>`;
    }else if(state.user){
      rolePill.innerHTML = `<span class="dot user"></span><span>Ù…Ø³ØªØ®Ø¯Ù…: ${escapeHtml(state.user?.email||"")}</span>`;
    }else{
      rolePill.innerHTML = `<span class="dot guest"></span><span>Ø²Ø§Ø¦Ø±</span>`;
    }
    btnShowLogin.style.display = state.user ? "none" : "inline-block";
    btnLogout.style.display    = state.user ? "inline-block" : "none";

    loginPanel.style.display = (!state.user) ? "block" : "none";
    adminPanel.style.display = (state.isAdmin) ? "block" : "none";

    scopeWrap.style.display = state.isAdmin ? "block" : "none";
  }

  function toggleBox(box, chev){
    const open = box.style.display !== "none";
    box.style.display = open ? "none" : "block";
    if(chev) chev.textContent = open ? "â–¾" : "â–´";
  }

  /* ===== Firebase init ===== */
  let app=null, auth=null, db=null;
  try{
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db   = getFirestore(app);
    state.firebaseReady = true;
  }catch(e){
    state.firebaseReady = false;
    demoNote.style.display = "block";
    demoNote.innerHTML = `âš ï¸ <b>Demo Mode:</b> Ø¨ÙŠØ§Ù†Ø§Øª Firebase ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ù†Ø§Ù‚ØµØ©.`;
  }

  async function checkIsAdmin(uid){
    try{
      const snap = await getDoc(doc(db, "admins", uid));
      return snap.exists();
    }catch(e){ return false; }
  }

  /* ===== Auth UI ===== */
  btnShowLogin.onclick = ()=>{ loginPanel.style.display="block"; window.scrollTo({top:0,behavior:"smooth"}); };
  btnLogout.onclick = async ()=>{ if(auth) await signOut(auth); };

  btnLogin.onclick = async ()=>{
    if(!state.firebaseReady) return alert("Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø². Ø¶Ø¹ firebaseConfig Ø§Ù„ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.");
    const email = loginEmail.value.trim();
    const pass  = loginPass.value;
    if(!email || !pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(err){ alert(err?.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."); }
  };

  btnForgot.onclick = async ()=>{
    if(!state.firebaseReady) return alert("Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø².");
    const email = loginEmail.value.trim();
    if(!email) return alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹.");
    try{
      await sendPasswordResetEmail(auth, email);
      alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ø³Ø¨Ø§Ù….");
    }catch(err){
      alert(err?.message || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.");
    }
  };

  publicHead.addEventListener("click", ()=>{ if(!state.isAdmin) return alert("Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·."); toggleBox(publicBox, publicChev); });
  weeksHead.addEventListener("click", ()=>{ if(!state.isAdmin) return alert("Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·."); toggleBox(weeksBox, weeksChev); });

  /* ===== Weeks draft ===== */
  let weeksDraft = [];
  function normalizeWeeksDraft(){
    weeksDraft = weeksDraft.map(w=>({
      id: w.id || null,
      order: Number(w.order||0),
      type: (w.type==="vac"?"vac":"week"),
      weekNumber: Number(w.weekNumber||0),
      title: (w.title||"").trim(),
      startDateISO: (w.startDateISO||"").trim()
    })).sort((a,b)=>a.order-b.order);
    weeksDraft.forEach((w,i)=>{ if(!w.order || w.order<1) w.order=i+1; });
    weeksDraft.sort((a,b)=>a.order-b.order);
  }
  function loadWeeksDraftFromState(){
    const src = (state.weeks && state.weeks.length) ? state.weeks : defaultWeeksFromFallback();
    weeksDraft = src.map(w=>({
      id:w.id||null,
      order:Number(w.order||0),
      type:(w.type==="vac"?"vac":"week"),
      weekNumber:Number(w.weekNumber||0),
      title:w.title||"",
      startDateISO:w.startDateISO||""
    }));
    normalizeWeeksDraft();
  }
  function renderWeeksTable(){
    weeksTbody.innerHTML = "";
    weeksDraft.forEach((w,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="mono" data-k="order" data-i="${idx}" type="number" min="1" value="${escapeHtml(w.order)}"></td>
        <td>
          <select data-k="type" data-i="${idx}">
            <option value="week" ${w.type==="week"?"selected":""}>week</option>
            <option value="vac" ${w.type==="vac"?"selected":""}>vac</option>
          </select>
        </td>
        <td><input class="mono" data-k="weekNumber" data-i="${idx}" type="number" min="0" value="${escapeHtml(w.weekNumber)}"></td>
        <td><input data-k="title" data-i="${idx}" type="text" value="${escapeHtml(w.title)}"></td>
        <td><input class="mono" data-k="startDateISO" data-i="${idx}" type="date" value="${escapeHtml(w.startDateISO)}"></td>
        <td><button class="danger" data-act="delWeek" data-i="${idx}">Ø­Ø°Ù</button></td>
      `;
      weeksTbody.appendChild(tr);
    });

    weeksTbody.querySelectorAll('select[data-k="type"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      const row = sel.closest("tr");
      const weekNum = row.querySelector('input[data-k="weekNumber"]');
      if(weeksDraft[i]?.type==="vac" && weekNum){
        weekNum.value="0"; weekNum.disabled=true; weekNum.style.opacity="0.6";
      }else if(weekNum){
        weekNum.disabled=false; weekNum.style.opacity="1";
      }
    });
  }

  document.addEventListener("input", (e)=>{
    const el = e.target;
    if(!el || !el.closest("#weeksTbody")) return;
    const i = Number(el.dataset.i);
    const k = el.dataset.k;
    if(Number.isNaN(i) || !k) return;
    let v = el.value;
    if(k==="order" || k==="weekNumber") v = Number(v||0);
    weeksDraft[i][k] = v;
  });

  document.addEventListener("change", (e)=>{
    const el = e.target;
    if(!el || !el.closest("#weeksTbody")) return;
    const i = Number(el.dataset.i);
    const k = el.dataset.k;
    if(Number.isNaN(i) || !k) return;

    if(k==="type"){
      weeksDraft[i].type = (el.value==="vac"?"vac":"week");
      if(weeksDraft[i].type==="vac") weeksDraft[i].weekNumber = 0;
      renderWeeksTable();
    }else{
      let v = el.value;
      if(k==="order" || k==="weekNumber") v = Number(v||0);
      weeksDraft[i][k] = v;
    }
  });

  document.addEventListener("click", async (e)=>{
    const delBtn = e.target.closest('button[data-act="delWeek"]');
    if(!delBtn) return;
    const i = Number(delBtn.dataset.i);
    if(Number.isNaN(i)) return;
    if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ")) return;

    const item = weeksDraft[i];
    try{
      if(state.firebaseReady && state.isAdmin && item.id){
        await deleteDoc(doc(db,"publicWeeks", item.id));
      }else{
        weeksDraft.splice(i,1);
        normalizeWeeksDraft();
        renderWeeksTable();
      }
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
    }
  });

  btnAddWeek.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)),0);
    weeksDraft.push({id:null,order:maxOrder+1,type:"week",weekNumber:0,title:"Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯",startDateISO:""});
    normalizeWeeksDraft(); renderWeeksTable();
  });

  btnAddVac.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)),0);
    weeksDraft.push({id:null,order:maxOrder+1,type:"vac",weekNumber:0,title:"Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)",startDateISO:""});
    normalizeWeeksDraft(); renderWeeksTable();
  });

  btnSaveWeeks.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø².");
    if(!state.isAdmin) return alert("Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");

    normalizeWeeksDraft();
    for(const w of weeksDraft){
      if(!w.startDateISO) return alert("ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¯ÙˆÙ† startDateISO.");
      if(w.type==="vac") w.weekNumber = 0;
    }

    try{
      const snap = await getDocs(collection(db,"publicWeeks"));
      const batch = writeBatch(db);
      snap.docs.forEach(d=> batch.delete(d.ref));

      weeksDraft.sort((a,b)=>a.order-b.order).forEach(w=>{
        const ref = doc(collection(db,"publicWeeks"));
        batch.set(ref, {
          order:Number(w.order),
          type:(w.type==="vac"?"vac":"week"),
          weekNumber:Number(w.weekNumber||0),
          title:(w.title||"").trim(),
          startDateISO:(w.startDateISO||"").trim()
        });
      });

      await batch.commit();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹.");
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹.");
    }
  });

  /* ===== Events delete ===== */
  async function deleteEvent(ev){
    try{
      if(!state.firebaseReady) return;
      if(ev.scope==="public"){
        if(!state.isAdmin) return;
        await deleteDoc(doc(db,"publicEvents",ev.id));
      }else{
        if(!state.user) return;
        await deleteDoc(doc(db,`users/${state.user.uid}/privateEvents`,ev.id));
      }
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
    }
  }

  /* ===== Admin: render public events table ===== */
  function renderPublicEventsTable(){
    if(!publicEventsTbody) return;
    publicEventsTbody.innerHTML = "";

    const list = state.publicEvents.slice().sort((a,b)=> String(a.dateISO).localeCompare(String(b.dateISO)));

    if(!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø©.</td>`;
      publicEventsTbody.appendChild(tr);
      return;
    }

    list.forEach(ev=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(ev.dateISO||"")}</td>
        <td>${escapeHtml(ev.title||"")}</td>
        <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(ev.note||"")}</td>
        <td><span style="display:inline-block;width:18px;height:18px;border-radius:6px;background:${escapeHtml(ev.color||"#7c5cff")};border:1px solid rgba(255,255,255,.18)"></span></td>
        <td>
          <button class="soft" data-act="editPublic" data-id="${ev.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="danger" data-act="delPublic" data-id="${ev.id}">Ø­Ø°Ù</button>
        </td>
      `;
      publicEventsTbody.appendChild(tr);
    });
  }

  document.addEventListener("click", async (e)=>{
    const editBtn = e.target.closest('button[data-act="editPublic"]');
    const delBtn  = e.target.closest('button[data-act="delPublic"]');

    if(editBtn){
      const id = editBtn.dataset.id;
      const ev = state.publicEvents.find(x=>x.id===id);
      if(!ev) return;
      openModal(ev.dateISO, { mode:"edit", scope:"public", id:ev.id, preset:ev });
      return;
    }

    if(delBtn){
      const id = delBtn.dataset.id;
      const ev = state.publicEvents.find(x=>x.id===id);
      if(!ev) return;
      if(!confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø§Ù…ØŸ")) return;
      await deleteEvent({scope:"public", id:ev.id});
      return;
    }
  });

  btnRefreshPublicList.addEventListener("click", ()=> renderPublicEventsTable());
  btnAdminAddPublicFromPanel.addEventListener("click", ()=>{
    const today = toISODate(new Date());
    openModal(today, { mode:"add", scope:"public" });
  });

  /* ===== CSV (Public) ===== */
  function parseCSV(text){
    const rows=[];
    let i=0, field="", row=[], inQ=false;
    const pushField=()=>{ row.push(field); field=""; };
    const pushRow=()=>{ rows.push(row); row=[]; };
    while(i<text.length){
      const c=text[i];
      if(inQ){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i++; }
          else inQ=false;
        } else field+=c;
      }else{
        if(c === '"') inQ=true;
        else if(c === ','){ pushField(); }
        else if(c === '\n'){ pushField(); pushRow(); }
        else if(c === '\r'){ }
        else field+=c;
      }
      i++;
    }
    pushField(); pushRow();
    return rows.filter(r=> r.some(x=>String(x||"").trim()!==""));
  }
  function rowsToObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>String(h||"").trim());
    return rows.slice(1).map(r=>{
      const obj={};
      headers.forEach((h,idx)=> obj[h]= (r[idx] ?? "").toString().trim());
      return obj;
    });
  }
  function normalizeImportedPublic(objs){
    const items=[], problems=[];
    objs.forEach((o,idx)=>{
      const dateISO = String(o.dateISO||"").trim();
      const title = String(o.title||"").trim();
      const note  = String(o.note||"").trim();
      const color = normColor(o.color);
      if(!isValidISODate(dateISO)) problems.push(`Ø§Ù„Ø³Ø·Ø± ${idx+2}: dateISO ØºÙŠØ± ØµØ­ÙŠØ­ (${dateISO})`);
      if(!title) problems.push(`Ø§Ù„Ø³Ø·Ø± ${idx+2}: title ÙØ§Ø±Øº`);
      if(isValidISODate(dateISO) && title){
        items.push({dateISO,title,note,color});
      }
    });
    return {items, problems};
  }
  async function batchWrite(ops){
    const CHUNK = 450;
    for(let i=0;i<ops.length;i+=CHUNK){
      const batch = writeBatch(db);
      ops.slice(i,i+CHUNK).forEach(x=>{
        if(x.op==="del") batch.delete(x.ref);
        else batch.set(x.ref, x.data);
      });
      await batch.commit();
    }
  }
  btnCsvPreview.addEventListener("click", async ()=>{
    if(!csvFile.files?.length) return alert("Ø§Ø®ØªØ± Ù…Ù„Ù CSV.");
    const text = await csvFile.files[0].text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const {items, problems} = normalizeImportedPublic(objs);
    csvResult.style.display="block";
    csvResult.innerHTML = `<b>Ø¬Ø§Ù‡Ø²:</b> ${items.length} â€” <b>Ù…Ø´Ø§ÙƒÙ„:</b> ${problems.length}`
      + (problems.length ? `<div style="margin-top:8px;color:var(--warn)">${problems.slice(0,10).map(escapeHtml).join("<br>")}</div>` : "");
  });
  btnCsvImport.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø².");
    if(!state.isAdmin) return alert("Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
    if(!csvFile.files?.length) return alert("Ø§Ø®ØªØ± Ù…Ù„Ù CSV.");

    const text = await csvFile.files[0].text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const {items, problems} = normalizeImportedPublic(objs);

    csvResult.style.display="block";
    csvResult.innerHTML = `<b>Ø¬Ø§Ù‡Ø²:</b> ${items.length} â€” <b>Ù…Ø´Ø§ÙƒÙ„:</b> ${problems.length}`;

    if(problems.length) return alert("Ø£ØµÙ„Ø­ Ù…Ø´Ø§ÙƒÙ„ CSV Ø£ÙˆÙ„Ø§Ù‹.");
    if(!items.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ØµØ§Ù„Ø­Ø©.");

    const mode = csvMode.value;
    const ops = [];

    try{
      if(mode==="replace_public"){
        const snap = await getDocs(collection(db,"publicEvents"));
        snap.docs.forEach(d=> ops.push({op:"del", ref:d.ref}));
      }
      items.forEach(it=>{
        const ref = doc(collection(db,"publicEvents"));
        ops.push({op:"set", ref, data:{dateISO:it.dateISO,title:it.title,note:it.note,color:it.color,createdAt:Date.now()}});
      });

      await batchWrite(ops);
      alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${items.length} Ø­Ø¯Ø« Ø¹Ø§Ù….`);
      csvFile.value="";
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.");
    }
  });

  /* ===== Modal Add/Edit ===== */
  const modalState = { mode:"add", id:null, scope:"private" };

  function openModal(dateISO, opts={}){
    modalState.mode  = opts.mode || "add";
    modalState.id    = opts.id || null;
    modalState.scope = opts.scope || (state.isAdmin ? "public" : "private");

    modalTitle.textContent = (modalState.mode==="edit") ? "ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¯Ø«" : "Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«";
    modalHint.textContent  = (modalState.scope==="public") ? "Ø¹Ø§Ù…" : "Ø®Ø§Øµ";

    mDate.value  = dateISO || "";
    mTitle.value = opts.preset?.title || "";
    mNote.value  = opts.preset?.note  || "";
    mColor.value = opts.preset?.color || (modalState.scope==="public" ? "#7c5cff" : "#35c6ff");

    if(state.isAdmin){
      scopeWrap.style.display = "block";
      mScope.value = modalState.scope;
    }else{
      scopeWrap.style.display = "none";
      mScope.value = "private";
    }

    modalBack.style.display = "flex";
    setTimeout(()=>mTitle.focus(), 50);
  }
  function closeModal(){ modalBack.style.display = "none"; }

  btnCloseModal.addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modalBack.style.display==="flex") closeModal(); });

  btnSaveModal.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø².");
    if(!state.user) return alert("Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");

    const dateISO = mDate.value;
    const title = mTitle.value.trim();
    const note  = mNote.value.trim();
    const color = mColor.value || "#35c6ff";
    if(!dateISO) return alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®.");
    if(!title) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.");
    if(!isValidISODate(dateISO)) return alert("ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");

    const finalScope = (state.isAdmin ? mScope.value : "private");

    try{
      if(finalScope==="public"){
        if(!state.isAdmin) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
        if(modalState.mode==="edit" && modalState.id){
          await updateDoc(doc(db,"publicEvents", modalState.id), {dateISO,title,note,color});
        }else{
          await addDoc(collection(db,"publicEvents"), {dateISO,title,note,color,createdAt:Date.now()});
        }
      }else{
        // private
        if(modalState.mode==="edit" && modalState.id && modalState.scope==="private"){
          await updateDoc(doc(db,`users/${state.user.uid}/privateEvents`, modalState.id), {dateISO,title,note,color});
        }else{
          await addDoc(collection(db,`users/${state.user.uid}/privateEvents`), {dateISO,title,note,color,createdAt:Date.now()});
        }
      }
      closeModal();
    }catch(err){
      alert(err?.message || "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸.");
    }
  });

  /* ===== Render calendar ===== */
  function renderCalendar(){
    const plan = (state.weeks && state.weeks.length)
      ? state.weeks.slice().sort((a,b)=>Number(a.order)-Number(b.order))
      : defaultWeeksFromFallback();

    const events = [...state.publicEvents, ...(state.user ? state.privateEvents : [])];
    const todayISO = toISODate(new Date());
    weeksGrid.innerHTML = "";

    plan.forEach(w=>{
      const weekStart = parseISOToDate(w.startDateISO);
      const weekEnd = addDays(weekStart, 6);

      const card = document.createElement("div");
      card.className = "week";

      const baseTitle =
        (w.title && String(w.title).trim()) ? w.title :
        (w.type==="vac" ? "Ø¥Ø¬Ø§Ø²Ø© (Ø£Ø³Ø¨ÙˆØ¹)" : `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${Number(w.weekNumber||0)}`);

      const rangeG = `${fmtG.format(weekStart)} â€” ${fmtG.format(weekEnd)}`;
      const rangeH = hasUmalqura ? `${fmtHijri.format(weekStart)} â€” ${fmtHijri.format(weekEnd)}` : "";
      const labelWeek = (w.type==="week" && Number(w.weekNumber||0) > 0)
        ? `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${Number(w.weekNumber)}`
        : (w.type==="vac" ? "Ø¥Ø¬Ø§Ø²Ø©" : "");

      card.innerHTML = `
        <div class="weekHead">
          <div class="title">
            <strong>${escapeHtml(baseTitle)}</strong>
            <span>(${escapeHtml(rangeG)}${hasUmalqura ? " | "+escapeHtml(rangeH) : ""}${labelWeek ? " â€” "+escapeHtml(labelWeek) : ""})</span>
          </div>
        </div>
        <div class="table"></div>
      `;
      const table = card.querySelector(".table");

      days.forEach(d=>{
        const th = document.createElement("div");
        th.className = "th" + (d.off ? " friSat" : "");
        th.textContent = d.name;
        table.appendChild(th);
      });

      days.forEach((d,di)=>{
        const date = addDays(weekStart, di);
        const iso = toISODate(date);
        const td = document.createElement("div");
        td.className = "td" + (d.off ? " friSat" : "");

        const hTxt = hasUmalqura ? fmtHijri.format(date) : "â€”";
        td.innerHTML = `<div class="gDate">${escapeHtml(fmtG.format(date))}</div><div class="hDate">${escapeHtml(hTxt)}</div>`;

        if(iso===todayISO){
          const b=document.createElement("div");
          b.className="today"; b.textContent="Ø§Ù„ÙŠÙˆÙ…";
          td.appendChild(b);
        }

        const wrap = document.createElement("div");
        wrap.className="events";

        events.filter(e=>e.dateISO===iso).forEach(ev=>{
          const item=document.createElement("div");
          item.className="ev";
          item.innerHTML = `
            <span class="tag" style="background:${escapeHtml(ev.color||"#7c5cff")}"></span>
            <div class="txt">
              <div style="font-weight:900">${escapeHtml(ev.title||"")}</div>
              ${ev.note ? `<div style="color:var(--muted);margin-top:2px">${escapeHtml(ev.note)}</div>` : ""}
              <div class="badge">${ev.scope==="public" ? "Ø¹Ø§Ù…" : "Ø®Ø§Øµ"}</div>
            </div>
            ${((ev.scope==="public" && state.isAdmin) || (ev.scope==="private" && state.user)) ? `<div class="x" title="Ø­Ø°Ù">Ã—</div>` : ""}
          `;

          item.addEventListener("click", (e)=> e.stopPropagation());
          const x=item.querySelector(".x");
          if(x){
            x.addEventListener("click",(e)=>{
              e.stopPropagation();
              if(!confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø«ØŸ")) return;
              deleteEvent(ev);
            });
          }

          // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø±ÙŠØ± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¯Ø«
          item.addEventListener("dblclick", (e)=>{
            e.stopPropagation();
            if(!state.user) return;
            if(ev.scope==="public" && !state.isAdmin) return;
            openModal(ev.dateISO, { mode:"edit", scope:ev.scope, id:ev.id, preset:ev });
          });

          wrap.appendChild(item);
        });

        td.appendChild(wrap);

        // âœ… Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…
        td.style.cursor = state.user ? "pointer" : "default";
        td.addEventListener("click", ()=>{
          if(!state.user) return alert("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«.");
          openModal(iso, { mode:"add", scope: (state.isAdmin ? "public" : "private") });
        });

        table.appendChild(td);
      });

      weeksGrid.appendChild(card);
    });

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
    if(state.isAdmin) renderPublicEventsTable();
  }

  /* ===== Start (local) ===== */
  loadWeeksDraftFromState();
  renderWeeksTable();
  renderCalendar();
  setRolePill();

  /* ===== Live Firebase ===== */
  if(state.firebaseReady){
    function listenPublicEvents(){
      const qy = query(collection(db,"publicEvents"), orderBy("dateISO","asc"));
      return onSnapshot(qy, (snap)=>{
        state.publicEvents = snap.docs.map(d=>({id:d.id, scope:"public", ...d.data()}));
        renderCalendar();
      });
    }
    function listenPrivateEvents(uid){
      const qy = query(collection(db,`users/${uid}/privateEvents`), orderBy("dateISO","asc"));
      return onSnapshot(qy, (snap)=>{
        state.privateEvents = snap.docs.map(d=>({id:d.id, scope:"private", ...d.data()}));
        renderCalendar();
      });
    }
    function listenWeeks(){
      const qy = query(collection(db,"publicWeeks"), orderBy("order","asc"));
      return onSnapshot(qy, (snap)=>{
        state.weeks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        loadWeeksDraftFromState();
        renderWeeksTable();
        renderCalendar();
      });
    }

    const unsubPublic = listenPublicEvents();
    const unsubWeeks  = listenWeeks();
    let unsubPrivate = null;

    onAuthStateChanged(auth, async (user)=>{
      state.user = user;

      if(unsubPrivate){ unsubPrivate(); unsubPrivate=null; }

      if(user){
        state.isAdmin = await checkIsAdmin(user.uid);
        unsubPrivate = listenPrivateEvents(user.uid);
      }else{
        state.isAdmin = false;
        state.privateEvents = [];
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ØºÙŠØ± Ø§Ù„Ø£Ø¯Ù…Ù†
      if(!state.isAdmin){
        publicBox.style.display = "none"; weeksBox.style.display = "none";
        publicChev.textContent = "â–¾"; weeksChev.textContent = "â–¾";
      }

      setRolePill();
      renderCalendar();
    });
  }
</script>
</body>
</html>
