<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التقويم الدراسي الأسبوعي (Pro)</title>

  <style>
    :root{
      --bg:#0f172a; --line:rgba(255,255,255,.10); --text:#e6eeff; --muted:#a7b4e6;
      --accent:#7c5cff; --ok:#2fe7a4; --warn:#ffd166; --danger:#ff5c7a;
      --friSat: rgba(255, 209, 102, .16);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Tahoma, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(124,92,255,.28), transparent 55%),
        radial-gradient(1000px 700px at 90% 25%, rgba(47,231,164,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:16px; padding:12px 14px; backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg, var(--accent), #35c6ff);
      box-shadow:0 10px 30px rgba(124,92,255,.25);
    }
    h1{margin:0;font-size:16px}
    .sub{margin-top:2px;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-size:12px;color:var(--muted);
      max-width: 100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.guest{background:rgba(255,255,255,.35)}
    .dot.user{background:rgba(53,198,255,.8)}
    .dot.admin{background:var(--ok)}
    button{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px;border-radius:12px; cursor:pointer;
      font-weight:900; transition:.12s transform,.12s background;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    button.primary{background:rgba(124,92,255,.25);border-color:rgba(124,92,255,.45)}
    button.danger{background:rgba(255,92,122,.16);border-color:rgba(255,92,122,.35)}
    button.soft{background:rgba(47,231,164,.10);border-color:rgba(47,231,164,.25)}

    .note{
      margin-top:12px; border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04); border-radius:14px;
      padding:10px 12px; color:var(--muted); font-size:12px;
    }

    .panels{margin-top:14px;display:grid;grid-template-columns:1fr;gap:12px}
    .panel{border:1px solid var(--line);border-radius:16px;overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    .panelHead{
      padding:12px 14px; display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      background:rgba(0,0,0,.18); border-bottom:1px solid var(--line); user-select:none;
    }
    .panelHead strong{font-size:13px}
    .panelBody{padding:12px 14px}
    .accordionHead{cursor:pointer}
    .accordionHead:hover{background:rgba(255,255,255,.06)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:860px){ .grid2{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .weeks{margin-top:14px;display:grid;gap:12px}
    .week{border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:16px; overflow:hidden;
    }
    .weekHead{padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(0,0,0,.18);
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .weekHead .title{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .weekHead .title strong{font-size:13px}
    .weekHead .title span{font-size:12px;color:var(--muted)}
    .table{display:grid; grid-template-columns: repeat(7, 1fr); border-top:1px solid var(--line)}
    .th,.td{padding:10px;border-left:1px solid var(--line);border-bottom:1px solid var(--line);min-height:96px;position:relative}
    .th{min-height:auto;background:rgba(255,255,255,.04);text-align:center;font-weight:900;padding:10px 6px}
    .th:last-child,.td:last-child{border-left:none}
    .friSat{background:var(--friSat)}
    .gDate{font-size:12px;color:var(--muted)}
    .hDate{font-size:12px}
    .today{
      position:absolute;top:8px;left:8px;font-size:11px;font-weight:900;color:var(--ok);
      padding:4px 8px;border-radius:999px;border:1px solid rgba(47,231,164,.45);background:rgba(47,231,164,.12);
    }
    .events{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .ev{
      display:flex;gap:8px;align-items:flex-start;justify-content:space-between;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      border-radius:12px; padding:6px 8px; font-size:12px;
    }
    .ev .tag{width:10px;height:10px;border-radius:3px;margin-top:3px;flex:0 0 auto}
    .ev .txt{flex:1}
    .ev .x{cursor:pointer;font-weight:900;color:rgba(255,255,255,.75);padding:0 6px;border-radius:8px;line-height:18px}
    .ev .x:hover{background:rgba(255,255,255,.08)}
    .badge{
      display:inline-flex;font-size:10px;font-weight:900;
      padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18); margin-top:6px;color:rgba(255,255,255,.9);
    }

    .scroll{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
    th,td{border-bottom:1px solid var(--line);padding:10px;font-size:12px;white-space:nowrap}
    th{position:sticky;top:0;background:rgba(255,255,255,.04);color:var(--muted);text-align:right;font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}

    .warnBox{
      border:1px solid rgba(255,209,102,.35);
      background:rgba(255,209,102,.10);
      border-radius:14px; padding:10px 12px; font-size:12px; color:rgba(255,255,255,.92);
    }
    .chev{opacity:.9;font-weight:900}
    .small{font-size:12px;color:var(--muted)}
    .okText{color:var(--ok);font-weight:900}
    .badText{color:var(--danger);font-weight:900}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>التقويم الدراسي الأسبوعي (Pro)</h1>
        <div class="sub">إدارة أسابيع + عام/خاص + استيراد CSV</div>
      </div>
    </div>

    <div class="actions">
      <span id="rolePill" class="pill"><span class="dot guest"></span><span>زائر</span></span>
      <button id="btnShowLogin" class="primary">دخول</button>
      <button id="btnLogout" style="display:none;">خروج</button>
    </div>
  </div>

  <div id="demoNote" class="note" style="display:none;"></div>

  <!-- Login panel -->
  <div class="panels" id="loginPanel" style="display:none;">
    <div class="panel">
      <div class="panelHead">
        <strong>تسجيل الدخول</strong>
        <span class="sub">التسجيل الجديد مغلق — المدير ينشئ الحسابات من Firebase</span>
      </div>
      <div class="panelBody">
        <div class="grid2">
          <div>
            <label>البريد الإلكتروني</label>
            <input id="loginEmail" type="email" placeholder="name@example.com">
          </div>
          <div>
            <label>كلمة المرور</label>
            <input id="loginPass" type="password" placeholder="••••••••">
          </div>
        </div>
        <div style="margin-top:10px" class="rowBtns">
          <button id="btnForgot" class="soft">نسيت كلمة المرور؟</button>
          <button id="btnLogin" class="primary">دخول</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User panel -->
  <div class="panels" id="userPanel" style="display:none;">
    <div class="panel">
      <div class="panelHead">
        <strong>إضافة حدث خاص (يظهر لك فقط)</strong>
        <span class="sub">اضغط على أي يوم لتعبئة التاريخ تلقائيًا</span>
      </div>
      <div class="panelBody">
        <div class="grid2">
          <div>
            <label>التاريخ</label>
            <input id="priDate" type="date">
          </div>
          <div>
            <label>اللون</label>
            <input id="priColor" type="color" value="#35c6ff">
          </div>
        </div>
        <div style="margin-top:10px">
          <label>العنوان</label>
          <input id="priTitle" type="text" placeholder="مثال: متابعة">
        </div>
        <div style="margin-top:10px">
          <label>ملاحظات (اختياري)</label>
          <textarea id="priNote" placeholder="تفاصيل..."></textarea>
        </div>
        <div style="margin-top:10px" class="rowBtns">
          <button id="btnAddPrivate" class="primary">إضافة الحدث الخاص</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin panel -->
  <div class="panels" id="adminPanel" style="display:none;">
    <div class="panel">
      <div class="panelHead">
        <strong>لوحة المدير</strong>
        <span class="sub">الأدمن من Firestore: admins/{uid}</span>
      </div>
      <div class="panelBody">
        <div class="warnBox" style="margin-bottom:10px">
          ✅ لتفعيل الأدمن: أنشئ وثيقة في Firestore داخل <b>admins</b> و Document ID = <b>UID</b> للمدير.
        </div>

        <div class="grid2">

          <!-- Public events accordion -->
          <div class="panel" style="border-radius:14px">
            <div id="publicHead" class="panelHead accordionHead">
              <strong>الأحداث العامة</strong>
              <span class="sub">اضغط لفتح/إغلاق نموذج الإضافة</span>
              <span class="chev" id="publicChev">▾</span>
            </div>

            <div id="publicEventBox" class="panelBody" style="display:none;">
              <div class="grid2">
                <div>
                  <label>التاريخ</label>
                  <input id="pubDate" type="date">
                </div>
                <div>
                  <label>اللون</label>
                  <input id="pubColor" type="color" value="#7c5cff">
                </div>
              </div>

              <div style="margin-top:10px">
                <label>العنوان</label>
                <input id="pubTitle" type="text" placeholder="مثال: بداية الاختبارات">
              </div>

              <div style="margin-top:10px">
                <label>ملاحظات (اختياري)</label>
                <textarea id="pubNote" placeholder="تفاصيل..."></textarea>
              </div>

              <div style="margin-top:10px" class="rowBtns">
                <button id="btnAddPublic" class="primary">إضافة الحدث العام</button>
              </div>
            </div>
          </div>

          <!-- Weeks admin accordion -->
          <div class="panel" style="border-radius:14px">
            <div id="weeksHead" class="panelHead accordionHead">
              <strong>إدارة الأسابيع</strong>
              <span class="sub">اضغط لفتح/إغلاق</span>
              <span class="chev" id="weeksChev">▾</span>
            </div>

            <div id="weeksAdminBox" class="panelBody" style="display:none;">
              <div class="rowBtns" style="justify-content:flex-start">
                <button id="btnAddWeek" class="soft">+ إضافة أسبوع</button>
                <button id="btnAddVac" class="soft">+ إضافة إجازة</button>
                <button id="btnSaveWeeks" class="primary">حفظ الأسابيع</button>
              </div>

              <div style="margin-top:10px" class="scroll">
                <table>
                  <thead>
                    <tr>
                      <th>order</th>
                      <th>type</th>
                      <th>weekNumber</th>
                      <th>title</th>
                      <th>startDateISO (أحد)</th>
                      <th>حذف</th>
                    </tr>
                  </thead>
                  <tbody id="weeksTbody"></tbody>
                </table>
              </div>

              <div class="note" style="margin-top:10px">
                ملاحظة: <b>startDateISO</b> لازم يكون تاريخ <b>الأحد</b> لبداية الأسبوع.
              </div>
            </div>
          </div>

        </div><!-- grid2 -->

        <!-- CSV Import (PRO) -->
        <div class="panel" style="border-radius:14px;margin-top:12px">
          <div id="csvHead" class="panelHead accordionHead">
            <strong>استيراد CSV (Pro)</strong>
            <span class="sub">استيراد دفعة واحدة للأحداث العامة/الخاصة</span>
            <span class="chev" id="csvChev">▾</span>
          </div>

          <div id="csvBox" class="panelBody" style="display:none;">
            <div class="note">
              الأعمدة المطلوبة: <span class="mono">dateISO,title,note,color,scope</span>
              <br>scope: <b>public</b> أو <b>private</b>. إذا لم يوجد scope: سيُحدَّد تلقائياً.
            </div>

            <div class="grid2" style="margin-top:10px">
              <div>
                <label>ملف CSV</label>
                <input id="csvFile" type="file" accept=".csv,text/csv">
              </div>
              <div>
                <label>سلوك الاستيراد</label>
                <select id="csvMode">
                  <option value="append">إضافة (بدون حذف القديم)</option>
                  <option value="replace_public">استبدال الأحداث العامة فقط (يحذف العامة ثم يضيف)</option>
                </select>
                <div class="small" style="margin-top:6px">
                  خيار الاستبدال يؤثر على <b>publicEvents</b> فقط.
                </div>
              </div>
            </div>

            <div class="rowBtns" style="margin-top:10px;justify-content:flex-start">
              <button id="btnCsvPreview" class="soft">معاينة</button>
              <button id="btnCsvImport" class="primary">استيراد</button>
            </div>

            <div id="csvResult" class="note" style="display:none;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Calendar -->
  <div class="weeks" id="weeksGrid"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, addDoc, deleteDoc,
    onSnapshot, query, orderBy, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ===== ضع إعدادات Firebase هنا ===== */
  const firebaseConfig = {
  apiKey: "AIzaSyAulObTByvUjUgz_8QD3el0DRKacmbdH9Y",
  authDomain: "calendar-w-2fcbe.firebaseapp.com",
  projectId: "calendar-w-2fcbe",
  storageBucket: "calendar-w-2fcbe.firebasestorage.app",
  messagingSenderId: "544490738732",
  appId: "1:544490738732:web:f1008e65eaa0c83b23ed89",
  measurementId: "G-MSBWPX2C75"
  };

  /* ===== Helpers ===== */
  const days = [
    {name:"الأحد", off:false},{name:"الإثنين", off:false},{name:"الثلاثاء", off:false},
    {name:"الأربعاء", off:false},{name:"الخميس", off:false},{name:"الجمعة", off:true},{name:"السبت", off:true},
  ];

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toISODate(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeekSunday(d){
    const x=new Date(d); const day=x.getDay();
    x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;
  }
  function parseISOToDate(iso){ return new Date((iso||"").trim()+"T00:00:00"); }
  function isValidISODate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(String(s||"").trim()); }
  function normColor(c){
    const x=String(c||"").trim();
    if(/^#[0-9a-fA-F]{6}$/.test(x)) return x;
    return "#7c5cff";
  }
  function cleanScope(s){
    const x=String(s||"").trim().toLowerCase();
    if(x==="public"||x==="private") return x;
    return "";
  }

  /* ===== Umm al-Qura ===== */
  const hasUmalqura = (() => {
    try{
      const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { day:"numeric" });
      return !!fmt.format(new Date());
    }catch(e){ return false; }
  })();
  const fmtHijri = hasUmalqura
    ? new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", { year:"numeric", month:"long", day:"numeric" })
    : null;
  const fmtG = new Intl.DateTimeFormat("ar-SA", { year:"numeric", month:"2-digit", day:"2-digit" });

  /* ===== Default weeks plan ===== */
  function buildDefaultWeekPlan(){
    const plan=[];
    for(let w=16; w<=19; w++) plan.push({ type:"week", weekNumber:w, title:`الأسبوع ${w}` });
    plan.push({ type:"vac", weekNumber:0, title:"إجازة (أسبوع)" });
    for(let w=1; w<=18; w++) plan.push({ type:"week", weekNumber:w, title:`الأسبوع ${w}` });
    return plan;
  }
  const basePlan = buildDefaultWeekPlan();
  const fallbackStartSunday = startOfWeekSunday(new Date());
  function defaultWeeksFromFallback(){
    return basePlan.map((w,i)=>({
      id:null, order:i+1, type:w.type, weekNumber:w.weekNumber, title:w.title,
      startDateISO: toISODate(addDays(fallbackStartSunday, i*7))
    }));
  }

  /* ===== UI Elements ===== */
  const rolePill = document.getElementById("rolePill");
  const demoNote = document.getElementById("demoNote");
  const weeksGrid = document.getElementById("weeksGrid");

  const loginPanel = document.getElementById("loginPanel");
  const userPanel  = document.getElementById("userPanel");
  const adminPanel = document.getElementById("adminPanel");

  const btnShowLogin = document.getElementById("btnShowLogin");
  const btnLogout    = document.getElementById("btnLogout");

  const loginEmail = document.getElementById("loginEmail");
  const loginPass  = document.getElementById("loginPass");
  const btnLogin   = document.getElementById("btnLogin");
  const btnForgot  = document.getElementById("btnForgot");

  const priDate = document.getElementById("priDate");
  const priColor= document.getElementById("priColor");
  const priTitle= document.getElementById("priTitle");
  const priNote = document.getElementById("priNote");
  const btnAddPrivate = document.getElementById("btnAddPrivate");

  const pubDate = document.getElementById("pubDate");
  const pubColor= document.getElementById("pubColor");
  const pubTitle= document.getElementById("pubTitle");
  const pubNote = document.getElementById("pubNote");
  const btnAddPublic = document.getElementById("btnAddPublic");

  const publicHead = document.getElementById("publicHead");
  const publicEventBox = document.getElementById("publicEventBox");
  const publicChev = document.getElementById("publicChev");

  const weeksHead = document.getElementById("weeksHead");
  const weeksAdminBox  = document.getElementById("weeksAdminBox");
  const weeksChev = document.getElementById("weeksChev");

  const btnAddWeek = document.getElementById("btnAddWeek");
  const btnAddVac  = document.getElementById("btnAddVac");
  const btnSaveWeeks = document.getElementById("btnSaveWeeks");
  const weeksTbody = document.getElementById("weeksTbody");

  // CSV PRO
  const csvHead = document.getElementById("csvHead");
  const csvBox = document.getElementById("csvBox");
  const csvChev = document.getElementById("csvChev");
  const csvFile = document.getElementById("csvFile");
  const csvMode = document.getElementById("csvMode");
  const btnCsvPreview = document.getElementById("btnCsvPreview");
  const btnCsvImport = document.getElementById("btnCsvImport");
  const csvResult = document.getElementById("csvResult");

  /* ===== App state ===== */
  const state = {
    user:null, isAdmin:false, firebaseReady:false,
    publicEvents:[], privateEvents:[], weeks:[]
  };

  function setRolePill(){
    if(state.isAdmin){
      rolePill.innerHTML = `<span class="dot admin"></span><span>مدير: ${escapeHtml(state.user?.email||"")}</span>`;
    }else if(state.user){
      rolePill.innerHTML = `<span class="dot user"></span><span>مستخدم: ${escapeHtml(state.user?.email||"")}</span>`;
    }else{
      rolePill.innerHTML = `<span class="dot guest"></span><span>زائر</span>`;
    }
    btnShowLogin.style.display = state.user ? "none" : "inline-block";
    btnLogout.style.display    = state.user ? "inline-block" : "none";

    loginPanel.style.display = (!state.user) ? "block" : "none";
    userPanel.style.display  = (state.user) ? "block" : "none";
    adminPanel.style.display = (state.isAdmin) ? "block" : "none";
  }

  function toggleBox(box, chev){
    const open = box.style.display !== "none";
    box.style.display = open ? "none" : "block";
    if(chev) chev.textContent = open ? "▾" : "▴";
  }

  /* ===== Firebase init (safe) ===== */
  let app=null, auth=null, db=null;
  try{
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db   = getFirestore(app);
    state.firebaseReady = true;
  }catch(e){
    state.firebaseReady = false;
    demoNote.style.display = "block";
    demoNote.innerHTML = `⚠️ <b>Demo Mode:</b> بيانات Firebase غير صحيحة أو ناقصة.`;
  }

  /* ===== Admin check via Firestore: admins/{uid} ===== */
  async function checkIsAdmin(uid){
    try{
      const snap = await getDoc(doc(db, "admins", uid));
      return snap.exists();
    }catch(e){ return false; }
  }

  /* ===== Accordion clicks ===== */
  publicHead?.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("هذه الميزة للمدير فقط.");
    toggleBox(publicEventBox, publicChev);
  });
  weeksHead?.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("هذه الميزة للمدير فقط.");
    toggleBox(weeksAdminBox, weeksChev);
  });
  csvHead?.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("هذه الميزة للمدير فقط.");
    toggleBox(csvBox, csvChev);
  });

  /* ===== Auth actions ===== */
  btnShowLogin.onclick = ()=>{
    loginPanel.style.display = "block";
    window.scrollTo({top:0, behavior:"smooth"});
  };
  btnLogout.onclick = async ()=>{ if(auth) await signOut(auth); };

  btnLogin.onclick = async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز. ضع firebaseConfig الصحيح أولاً.");
    const email = loginEmail.value.trim();
    const pass  = loginPass.value;
    if(!email || !pass) return alert("أدخل البريد وكلمة المرور.");
    try{ await signInWithEmailAndPassword(auth, email, pass); }
    catch(err){ alert(err?.message || "فشل تسجيل الدخول."); }
  };

  btnForgot.onclick = async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز.");
    const email = loginEmail.value.trim();
    if(!email) return alert("اكتب بريدك الإلكتروني أولاً.");
    try{
      await sendPasswordResetEmail(auth, email);
      alert("تم إرسال رابط إعادة تعيين كلمة المرور. تحقق من البريد/السبام.");
    }catch(err){
      alert(err?.message || "تعذر إرسال رابط إعادة التعيين.");
    }
  };

  /* ===== Weeks editor (draft) ===== */
  let weeksDraft = [];
  function normalizeWeeksDraft(){
    weeksDraft = weeksDraft.map(w=>({
      id: w.id || null,
      order: Number(w.order||0),
      type: (w.type==="vac"?"vac":"week"),
      weekNumber: Number(w.weekNumber||0),
      title: (w.title||"").trim(),
      startDateISO: (w.startDateISO||"").trim()
    })).sort((a,b)=>a.order-b.order);
    weeksDraft.forEach((w,i)=>{ if(!w.order || w.order<1) w.order=i+1; });
    weeksDraft.sort((a,b)=>a.order-b.order);
  }
  function loadWeeksDraftFromState(){
    const src = (state.weeks && state.weeks.length) ? state.weeks : defaultWeeksFromFallback();
    weeksDraft = src.map(w=>({
      id:w.id||null,
      order:Number(w.order||0),
      type:(w.type==="vac"?"vac":"week"),
      weekNumber:Number(w.weekNumber||0),
      title:w.title||"",
      startDateISO:w.startDateISO||""
    }));
    normalizeWeeksDraft();
  }
  function renderWeeksTable(){
    if(!weeksTbody) return;
    weeksTbody.innerHTML = "";
    weeksDraft.forEach((w,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="mono" data-k="order" data-i="${idx}" type="number" min="1" value="${escapeHtml(w.order)}"></td>
        <td>
          <select data-k="type" data-i="${idx}">
            <option value="week" ${w.type==="week"?"selected":""}>week</option>
            <option value="vac" ${w.type==="vac"?"selected":""}>vac</option>
          </select>
        </td>
        <td><input class="mono" data-k="weekNumber" data-i="${idx}" type="number" min="0" value="${escapeHtml(w.weekNumber)}"></td>
        <td><input data-k="title" data-i="${idx}" type="text" value="${escapeHtml(w.title)}"></td>
        <td><input class="mono" data-k="startDateISO" data-i="${idx}" type="date" value="${escapeHtml(w.startDateISO)}"></td>
        <td><button class="danger" data-act="delWeek" data-i="${idx}">حذف</button></td>
      `;
      weeksTbody.appendChild(tr);
    });

    weeksTbody.querySelectorAll('select[data-k="type"]').forEach(sel=>{
      const i = Number(sel.dataset.i);
      const row = sel.closest("tr");
      const weekNum = row.querySelector('input[data-k="weekNumber"]');
      if(weeksDraft[i]?.type==="vac" && weekNum){
        weekNum.value="0"; weekNum.disabled=true; weekNum.style.opacity="0.6";
      }else if(weekNum){
        weekNum.disabled=false; weekNum.style.opacity="1";
      }
    });
  }

  document.addEventListener("input", (e)=>{
    const el = e.target;
    if(!el || !el.closest("#weeksTbody")) return;
    const i = Number(el.dataset.i);
    const k = el.dataset.k;
    if(Number.isNaN(i) || !k) return;
    let v = el.value;
    if(k==="order" || k==="weekNumber") v = Number(v||0);
    weeksDraft[i][k] = v;
  });

  document.addEventListener("change", (e)=>{
    const el = e.target;
    if(!el || !el.closest("#weeksTbody")) return;
    const i = Number(el.dataset.i);
    const k = el.dataset.k;
    if(Number.isNaN(i) || !k) return;

    if(k==="type"){
      weeksDraft[i].type = (el.value==="vac"?"vac":"week");
      if(weeksDraft[i].type==="vac") weeksDraft[i].weekNumber = 0;
      renderWeeksTable();
    }else{
      let v = el.value;
      if(k==="order" || k==="weekNumber") v = Number(v||0);
      weeksDraft[i][k] = v;
    }
  });

  document.addEventListener("click", async (e)=>{
    const delBtn = e.target.closest('button[data-act="delWeek"]');
    if(!delBtn) return;
    const i = Number(delBtn.dataset.i);
    if(Number.isNaN(i)) return;
    if(!confirm("حذف هذا الأسبوع؟")) return;

    const item = weeksDraft[i];
    try{
      if(state.firebaseReady && state.isAdmin && item.id){
        await deleteDoc(doc(db,"publicWeeks", item.id));
      }else{
        weeksDraft.splice(i,1);
        normalizeWeeksDraft();
        renderWeeksTable();
      }
    }catch(err){
      alert(err?.message || "فشل الحذف.");
    }
  });

  btnAddWeek?.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("للمدير فقط.");
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)),0);
    weeksDraft.push({id:null,order:maxOrder+1,type:"week",weekNumber:0,title:"أسبوع جديد",startDateISO:""});
    normalizeWeeksDraft(); renderWeeksTable();
  });

  btnAddVac?.addEventListener("click", ()=>{
    if(!state.isAdmin) return alert("للمدير فقط.");
    const maxOrder = weeksDraft.reduce((m,w)=>Math.max(m, Number(w.order||0)),0);
    weeksDraft.push({id:null,order:maxOrder+1,type:"vac",weekNumber:0,title:"إجازة (أسبوع)",startDateISO:""});
    normalizeWeeksDraft(); renderWeeksTable();
  });

  btnSaveWeeks?.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز.");
    if(!state.isAdmin) return alert("هذه العملية للمدير فقط.");

    normalizeWeeksDraft();
    for(const w of weeksDraft){
      if(!w.startDateISO) return alert("يوجد أسبوع بدون startDateISO.");
      if(w.type==="vac") w.weekNumber = 0;
    }

    try{
      const snap = await getDocs(collection(db,"publicWeeks"));
      const batch = writeBatch(db);
      snap.docs.forEach(d=> batch.delete(d.ref));
      weeksDraft.sort((a,b)=>a.order-b.order).forEach(w=>{
        const ref = doc(collection(db,"publicWeeks"));
        batch.set(ref, {
          order:Number(w.order),
          type:(w.type==="vac"?"vac":"week"),
          weekNumber:Number(w.weekNumber||0),
          title:(w.title||"").trim(),
          startDateISO:(w.startDateISO||"").trim()
        });
      });
      await batch.commit();
      alert("تم حفظ الأسابيع.");
    }catch(err){
      alert(err?.message || "فشل حفظ الأسابيع.");
    }
  });

  /* ===== Events add ===== */
  btnAddPublic?.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز.");
    if(!state.isAdmin) return alert("للمدير فقط.");

    const dateISO = pubDate.value;
    const title = pubTitle.value.trim();
    const note = pubNote.value.trim();
    const color = pubColor.value || "#7c5cff";
    if(!dateISO) return alert("اختر التاريخ.");
    if(!title) return alert("اكتب العنوان.");

    try{
      await addDoc(collection(db,"publicEvents"), {dateISO,title,note,color,createdAt:Date.now()});
      pubTitle.value=""; pubNote.value="";
      alert("تمت إضافة حدث عام.");
    }catch(err){
      alert(err?.message || "فشل إضافة الحدث العام.");
    }
  });

  btnAddPrivate?.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز.");
    if(!state.user) return alert("سجل الدخول أولاً.");

    const dateISO = priDate.value;
    const title = priTitle.value.trim();
    const note = priNote.value.trim();
    const color = priColor.value || "#35c6ff";
    if(!dateISO) return alert("اختر التاريخ.");
    if(!title) return alert("اكتب العنوان.");

    try{
      await addDoc(collection(db,`users/${state.user.uid}/privateEvents`), {dateISO,title,note,color,createdAt:Date.now()});
      priTitle.value=""; priNote.value="";
      alert("تمت إضافة حدث خاص.");
    }catch(err){
      alert(err?.message || "فشل إضافة الحدث الخاص.");
    }
  });

  async function deleteEvent(ev){
    try{
      if(!state.firebaseReady) return;
      if(ev.scope==="public"){
        if(!state.isAdmin) return;
        await deleteDoc(doc(db,"publicEvents",ev.id));
      }else{
        if(!state.user) return;
        await deleteDoc(doc(db,`users/${state.user.uid}/privateEvents`,ev.id));
      }
    }catch(err){
      alert(err?.message || "فشل الحذف.");
    }
  }

  /* ===== CSV (PRO) ===== */
  function parseCSV(text){
    // CSV parser بسيط يدعم علامات اقتباس
    const rows=[];
    let i=0, field="", row=[], inQ=false;
    const pushField=()=>{ row.push(field); field=""; };
    const pushRow=()=>{ rows.push(row); row=[]; };
    while(i<text.length){
      const c=text[i];
      if(inQ){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i++; }
          else inQ=false;
        } else field+=c;
      }else{
        if(c === '"') inQ=true;
        else if(c === ','){ pushField(); }
        else if(c === '\n'){ pushField(); pushRow(); }
        else if(c === '\r'){ /* ignore */ }
        else field+=c;
      }
      i++;
    }
    pushField(); pushRow();
    // حذف الصفوف الفارغة
    return rows.filter(r=> r.some(x=>String(x||"").trim()!==""));
  }

  function rowsToObjects(rows){
    if(!rows.length) return [];
    const headers = rows[0].map(h=>String(h||"").trim());
    const data = rows.slice(1);
    return data.map(r=>{
      const obj={};
      headers.forEach((h,idx)=> obj[h]= (r[idx] ?? "").toString().trim());
      return obj;
    });
  }

  function summarizeImport(items, problems){
    const pub = items.filter(x=>x.scope==="public").length;
    const pri = items.filter(x=>x.scope==="private").length;
    let html = `<b>جاهز للاستيراد:</b> <span class="okText">${items.length}</span> (عام: ${pub} | خاص: ${pri})`;
    if(problems.length){
      html += `<br><b>مشاكل:</b> <span class="badText">${problems.length}</span>`;
      html += `<div class="small" style="margin-top:6px">أول 10 مشاكل:<br>${problems.slice(0,10).map(p=>escapeHtml(p)).join("<br>")}</div>`;
    }
    return html;
  }

  function normalizeImportedObjects(objs){
    const items=[], problems=[];
    objs.forEach((o,idx)=>{
      const dateISO = String(o.dateISO||"").trim();
      const title = String(o.title||"").trim();
      const note  = String(o.note||"").trim();
      const color = normColor(o.color);
      let scope = cleanScope(o.scope);

      if(!scope){
        // default scope حسب الدور
        scope = state.isAdmin ? "public" : "private";
      }

      if(!isValidISODate(dateISO)) problems.push(`السطر ${idx+2}: dateISO غير صحيح (${dateISO})`);
      if(!title) problems.push(`السطر ${idx+2}: title فارغ`);
      if(scope==="public" && !state.isAdmin) problems.push(`السطر ${idx+2}: scope=public يحتاج مدير`);

      if(isValidISODate(dateISO) && title && (scope==="private" || state.isAdmin)){
        items.push({
          dateISO,
          title,
          note,
          color,
          scope
        });
      }
    });
    return {items, problems};
  }

  async function batchWriteDocs(makeRefAndData){
    // تقسيم إلى دفعات <= 450 لتجنب حدود 500
    const CHUNK = 450;
    for(let i=0;i<makeRefAndData.length;i+=CHUNK){
      const slice = makeRefAndData.slice(i,i+CHUNK);
      const batch = writeBatch(db);
      slice.forEach(({ref,data,op})=>{
        if(op==="set") batch.set(ref,data);
        else if(op==="del") batch.delete(ref);
      });
      await batch.commit();
    }
  }

  btnCsvPreview?.addEventListener("click", async ()=>{
    if(!csvFile.files?.length) return alert("اختر ملف CSV.");
    const f = csvFile.files[0];
    const text = await f.text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const {items, problems} = normalizeImportedObjects(objs);
    csvResult.style.display = "block";
    csvResult.innerHTML = summarizeImport(items, problems);
  });

  btnCsvImport?.addEventListener("click", async ()=>{
    if(!state.firebaseReady) return alert("Firebase غير جاهز.");
    if(!state.isAdmin) return alert("الاستيراد من لوحة المدير فقط.");
    if(!csvFile.files?.length) return alert("اختر ملف CSV.");

    const f = csvFile.files[0];
    const text = await f.text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const {items, problems} = normalizeImportedObjects(objs);

    csvResult.style.display = "block";
    csvResult.innerHTML = summarizeImport(items, problems);

    if(problems.length) return alert("يوجد أخطاء في CSV. أصلحها ثم أعد الاستيراد.");
    if(!items.length) return alert("لا يوجد عناصر صالحة للاستيراد.");

    const mode = csvMode.value;

    // تجهيز عمليات الكتابة
    const ops = [];

    try{
      // replace_public: حذف كل publicEvents أولاً
      if(mode === "replace_public"){
        const snap = await getDocs(collection(db,"publicEvents"));
        snap.docs.forEach(d=>{
          ops.push({op:"del", ref: d.ref});
        });
      }

      items.forEach(it=>{
        if(it.scope==="public"){
          const ref = doc(collection(db,"publicEvents"));
          ops.push({op:"set", ref, data:{...it, createdAt:Date.now()}});
        }else{
          // private: نخزنها تحت المستخدم الحالي (المدير أيضاً له privateEvents)
          const uid = state.user?.uid;
          if(!uid) return;
          const ref = doc(collection(db, `users/${uid}/privateEvents`));
          ops.push({op:"set", ref, data:{...it, createdAt:Date.now()}});
        }
      });

      await batchWriteDocs(ops);
      alert(`تم الاستيراد بنجاح: ${items.length} حدث.`);
      csvFile.value="";
    }catch(err){
      alert(err?.message || "فشل الاستيراد.");
    }
  });

  /* ===== Render calendar ===== */
  function renderCalendar(){
    const plan = (state.weeks && state.weeks.length)
      ? state.weeks.slice().sort((a,b)=>Number(a.order)-Number(b.order))
      : defaultWeeksFromFallback();

    const events = [...state.publicEvents, ...(state.user ? state.privateEvents : [])];
    const todayISO = toISODate(new Date());
    weeksGrid.innerHTML = "";

    plan.forEach(w=>{
      const weekStart = parseISOToDate(w.startDateISO);
      const weekEnd = addDays(weekStart, 6);

      const card = document.createElement("div");
      card.className = "week";

      const baseTitle =
        (w.title && String(w.title).trim()) ? w.title :
        (w.type==="vac" ? "إجازة (أسبوع)" : `الأسبوع ${Number(w.weekNumber||0)}`);

      const rangeG = `${fmtG.format(weekStart)} — ${fmtG.format(weekEnd)}`;
      const rangeH = hasUmalqura ? `${fmtHijri.format(weekStart)} — ${fmtHijri.format(weekEnd)}` : "";
      const labelWeek = (w.type==="week" && Number(w.weekNumber||0) > 0)
        ? `الأسبوع الدراسي: ${Number(w.weekNumber)}`
        : (w.type==="vac" ? "إجازة" : "");

      card.innerHTML = `
        <div class="weekHead">
          <div class="title">
            <strong>${escapeHtml(baseTitle)}</strong>
            <span>(${escapeHtml(rangeG)}${hasUmalqura ? " | "+escapeHtml(rangeH) : ""}${labelWeek ? " — "+escapeHtml(labelWeek) : ""})</span>
          </div>
        </div>
        <div class="table"></div>
      `;
      const table = card.querySelector(".table");

      days.forEach(d=>{
        const th = document.createElement("div");
        th.className = "th" + (d.off ? " friSat" : "");
        th.textContent = d.name;
        table.appendChild(th);
      });

      days.forEach((d,di)=>{
        const date = addDays(weekStart, di);
        const iso = toISODate(date);
        const td = document.createElement("div");
        td.className = "td" + (d.off ? " friSat" : "");

        const hTxt = hasUmalqura ? fmtHijri.format(date) : "—";
        td.innerHTML = `<div class="gDate">${escapeHtml(fmtG.format(date))}</div><div class="hDate">${escapeHtml(hTxt)}</div>`;

        if(iso===todayISO){
          const b=document.createElement("div");
          b.className="today"; b.textContent="اليوم";
          td.appendChild(b);
        }

        const wrap = document.createElement("div");
        wrap.className="events";

        events.filter(e=>e.dateISO===iso).forEach(ev=>{
          const item=document.createElement("div");
          item.className="ev";
          item.innerHTML = `
            <span class="tag" style="background:${escapeHtml(ev.color||"#7c5cff")}"></span>
            <div class="txt">
              <div style="font-weight:900">${escapeHtml(ev.title||"")}</div>
              ${ev.note ? `<div style="color:var(--muted);margin-top:2px">${escapeHtml(ev.note)}</div>` : ""}
              <div class="badge">${ev.scope==="public" ? "عام" : "خاص"}</div>
            </div>
            ${((ev.scope==="public" && state.isAdmin) || (ev.scope==="private" && state.user)) ? `<div class="x" title="حذف">×</div>` : ""}
          `;
          item.addEventListener("click", (e)=> e.stopPropagation());
          const x=item.querySelector(".x");
          if(x){
            x.addEventListener("click",(e)=>{
              e.stopPropagation();
              if(confirm("حذف الحدث؟")) deleteEvent(ev);
            });
          }
          wrap.appendChild(item);
        });

        td.appendChild(wrap);

        td.style.cursor = state.user ? "pointer" : "default";
        td.addEventListener("click", ()=>{
          if(!state.user) return;
          priDate.value = iso;
          priTitle.focus();
        });

        table.appendChild(td);
      });

      weeksGrid.appendChild(card);
    });
  }

  /* ===== Start (local) ===== */
  loadWeeksDraftFromState();
  renderWeeksTable();
  renderCalendar();
  setRolePill();

  /* ===== Live Firebase ===== */
  if(state.firebaseReady){
    function listenPublicEvents(){
      const qy = query(collection(db,"publicEvents"), orderBy("dateISO","asc"));
      return onSnapshot(qy, (snap)=>{
        state.publicEvents = snap.docs.map(d=>({id:d.id, scope:"public", ...d.data()}));
        renderCalendar();
      });
    }
    function listenPrivateEvents(uid){
      const qy = query(collection(db,`users/${uid}/privateEvents`), orderBy("dateISO","asc"));
      return onSnapshot(qy, (snap)=>{
        state.privateEvents = snap.docs.map(d=>({id:d.id, scope:"private", ...d.data()}));
        renderCalendar();
      });
    }
    function listenWeeks(){
      const qy = query(collection(db,"publicWeeks"), orderBy("order","asc"));
      return onSnapshot(qy, (snap)=>{
        state.weeks = snap.docs.map(d=>({id:d.id, ...d.data()}));
        loadWeeksDraftFromState();
        renderWeeksTable();
        renderCalendar();
      });
    }

    let unsubPublic = listenPublicEvents();
    let unsubWeeks  = listenWeeks();
    let unsubPrivate = null;

    onAuthStateChanged(auth, async (user)=>{
      state.user = user;
      if(unsubPrivate){ unsubPrivate(); unsubPrivate=null; }

      if(user){
        state.isAdmin = await checkIsAdmin(user.uid);
        unsubPrivate = listenPrivateEvents(user.uid);
      }else{
        state.isAdmin = false;
      }

      // اغلاق الأكوردين لغير الأدمن
      if(!state.isAdmin){
        publicEventBox.style.display = "none"; weeksAdminBox.style.display = "none"; csvBox.style.display="none";
        publicChev.textContent = "▾"; weeksChev.textContent = "▾"; csvChev.textContent="▾";
      }

      setRolePill();
      renderCalendar();
    });
  }
</script>
</body>
</html>
